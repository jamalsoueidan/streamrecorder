import { FollowerTypeText } from "@/app/(protected)/components/follower-type-text";
import { getProfileUrl } from "@/app/(protected)/components/open-social";
import PaginationControls from "@/app/(protected)/components/pagination";
import { formatDuration } from "@/app/(protected)/components/video/player-utils";
import dayjs from "@/app/lib/dayjs";
import publicApi from "@/lib/public-api";
import { FollowerTypeEnum } from "@/lib/types/strapi-autogenerated";
import {
  ActionIcon,
  Anchor,
  Badge,
  Card,
  Center,
  Flex,
  Image,
  SimpleGrid,
  Stack,
  Text,
} from "@mantine/core";
import { IconClock, IconPlayerPlay } from "@tabler/icons-react";
import { streamingPlatforms } from "../../page";

interface PageProps {
  params: Promise<{
    type: string;
  }>;
  searchParams: Promise<{
    page?: string;
  }>;
}

export default async function RecordingTypePage({
  params,
  searchParams,
}: PageProps) {
  const { type } = await params;
  const { page } = await searchParams;

  const platform = streamingPlatforms.find(
    (p) => p.name.toLowerCase() === type
  ) || {
    color: "#ff0050",
    name: "",
    file: "creators.png",
  };

  const {
    data: { data: recordings, meta },
  } = await publicApi.recording.getRecordings({
    filters: {
      ...(type === "all"
        ? {}
        : {
            follower: {
              type,
            },
          }),
      sources: {
        state: {
          $eq: ["done"],
        },
      },
    },
    "pagination[pageSize]": 20,
    "pagination[page]": parseInt(page || "1"),

    sort: "createdAt:desc",
    populate: {
      sources: {
        fields: ["*"],
        filters: {
          state: {
            $eq: "done",
          },
        },
      },
      follower: {
        fields: ["*"],
      },
    },
  });

  const totalPages = meta?.pagination?.pageCount || 1;

  return (
    <div style={{ marginTop: 60 }}>
      <SimpleGrid cols={{ base: 1, sm: 4 }}>
        {recordings?.map((recording) => {
          const totalDuration =
            recording.sources?.reduce((sum, s) => sum + (s.duration || 0), 0) ||
            0;

          const uri = recording.sources?.length
            ? "/media" + recording.sources[recording.sources.length - 1].path
            : null;

          return (
            <div key={recording.id}>
              <Anchor
                href={`${getProfileUrl(
                  recording.follower?.username || "",
                  recording.follower?.type || FollowerTypeEnum.Tiktok
                )}/video/${recording.documentId}`}
                underline="never"
              >
                <Card
                  padding={0}
                  style={{
                    background: "rgba(255, 255, 255, 0.02)",
                    border: "1px solid rgba(255, 255, 255, 0.06)",
                    borderRadius: "16px",
                    overflow: "hidden",
                    cursor: "pointer",
                  }}
                >
                  <div style={{ position: "relative" }}>
                    <Image
                      src={uri + "preview.jpg"}
                      alt={recording.follower?.username}
                      height={160}
                    />
                    <div
                      style={{
                        position: "absolute",
                        inset: 0,
                        background:
                          "linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%)",
                      }}
                    />
                    <Badge
                      style={{
                        position: "absolute",
                        top: 12,
                        left: 12,
                        background: "rgba(0, 0, 0, 0.6)",
                        backdropFilter: "blur(8px)",
                      }}
                    >
                      {recording.follower?.type}
                    </Badge>
                    <Flex
                      align="center"
                      gap={4}
                      style={{
                        position: "absolute",
                        bottom: 12,
                        right: 12,
                        background: "rgba(0, 0, 0, 0.7)",
                        padding: "4px 8px",
                        borderRadius: "6px",
                      }}
                    >
                      <IconClock size={12} color="#fff" />
                      <Text size="xs" c="white">
                        {formatDuration(totalDuration)}
                      </Text>
                    </Flex>
                    <ActionIcon
                      variant="filled"
                      size="xl"
                      radius="xl"
                      style={{
                        position: "absolute",
                        top: "50%",
                        left: "50%",
                        transform: "translate(-50%, -50%)",
                        background: "rgba(99, 102, 241, 0.9)",
                        opacity: 0.9,
                      }}
                    >
                      <IconPlayerPlay size={20} />
                    </ActionIcon>
                  </div>
                  <Flex p={16} align="center" justify="space-between">
                    <Stack gap={2}>
                      <Text
                        fw={600}
                        size="sm"
                        lineClamp={2}
                        style={{ color: "#f1f5f9", lineHeight: 1.4 }}
                      >
                        {recording.follower?.nickname || "-"} @
                      </Text>

                      <Text size="xs" c="dimmed">
                        Recorded{" "}
                        <time dateTime={recording.createdAt}>
                          {dayjs(recording.createdAt).format("MMM D, YYYY")}
                        </time>
                      </Text>
                    </Stack>

                    <FollowerTypeText type={recording.follower?.type} w={70} />
                  </Flex>
                </Card>
              </Anchor>
            </div>
          );
        })}
      </SimpleGrid>
      {totalPages > 1 && (
        <Center mt={40}>
          <PaginationControls total={totalPages} size="lg" />
        </Center>
      )}
    </div>
  );
}
