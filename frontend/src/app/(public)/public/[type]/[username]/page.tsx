import { ActionIcon, SimpleGrid, Stack, Text, Title } from "@mantine/core";
import { IconVideo } from "@tabler/icons-react";

import dayjs from "@/app/lib/dayjs";
import { fetchProfileRecordings, getFollower } from "./actions/actions";

import { FollowerTypeEnum } from "@/lib/types/strapi-autogenerated";
import { ImageVideoPreview } from "./components/image-video-preview";

interface PageProps {
  params: Promise<{
    username: string;
    type: string;
  }>;
}

export default async function Page({ params }: PageProps) {
  const { type, username } = await params;

  const follower = await getFollower({ username, type });

  const data = await fetchProfileRecordings(type, username);

  const recordings = data?.data ?? [];
  const hasRecordings = recordings.length > 0;

  const jsonLd = {
    "@context": "https://schema.org",
    "@type": "Person",
    name: follower.nickname,
    description: follower.description,
    image: follower.avatar?.url,
    url: `https://www.livestreamrecorder.com/${follower.type}/${follower.username}`,
    video: recordings.slice(0, 5).map((video) => {
      const duration =
        video.sources?.reduce(
          (acc, source) => acc + (source.duration || 0),
          0
        ) || 0;

      return {
        "@type": "VideoObject",
        name: `${follower.nickname} Stream - ${dayjs(video.createdAt).format(
          "MMM D, YYYY"
        )}`,
        thumbnailUrl: video.sources?.length
          ? "https://www.livestreamrecorder.com/media" +
            video.sources[video.sources.length - 1].path +
            "screenshot.jpg"
          : null,
        uploadDate: video.createdAt,
        duration: `PT${Math.floor(duration / 60)}M${Math.round(
          duration % 60
        )}S`,
        contentUrl: `https://www.livestreamrecorder.com/${follower?.type}/${follower?.username}/video/${video.documentId}`,
      };
    }),
    nationality: follower.country,
    sameAs: [`https://tiktok.com/@${follower.username}`],
  };

  return (
    <>
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
      />
      {!hasRecordings ? (
        <EmptyState />
      ) : (
        <Stack gap="xl">
          <Stack gap="md">
            <SimpleGrid cols={{ base: 1, sm: 2 }} spacing="lg">
              {recordings?.map((rec) => (
                <Stack key={rec.documentId} gap={4}>
                  <ImageVideoPreview
                    recording={rec}
                    username={username}
                    type={type as unknown as FollowerTypeEnum}
                  />
                  <Text size="xs">
                    Recorded{" "}
                    <time dateTime={rec.createdAt}>
                      {dayjs(rec.createdAt).format("MMM D, YYYY")}
                    </time>
                  </Text>
                </Stack>
              ))}
            </SimpleGrid>
          </Stack>
        </Stack>
      )}
    </>
  );
}

function EmptyState() {
  return (
    <Stack align="center" justify="center" py={80} gap="lg">
      <ActionIcon variant="transparent" size={120} radius="xl" color="white">
        <IconVideo size={90} stroke={2} />
      </ActionIcon>
      <Stack align="center" gap={12}>
        <Title order={2} fw={600}>
          No recordings yet
        </Title>
        <Text size="xl" c="dimmed" maw={450} ta="center">
          We haven&apos;t captured any streams from this creator yet. Check back
          later!
        </Text>
      </Stack>
    </Stack>
  );
}
