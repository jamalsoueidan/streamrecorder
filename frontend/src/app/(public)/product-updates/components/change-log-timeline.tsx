"use client";

import dayjs from "@/app/lib/dayjs";
import { ChangeLog } from "@/lib/types/strapi-autogenerated";
import { Badge, Flex, Paper, Stack, Text } from "@mantine/core";
import {
  IconCalendar,
  IconGitBranch,
  IconRocket,
  IconSparkles,
} from "@tabler/icons-react";
import { marked } from "marked";

function getVersionColor(version: string): {
  from: string;
  to: string;
  badge: string;
} {
  if (version.startsWith("0."))
    return { from: "#3b82f6", to: "#06b6d4", badge: "blue" };
  if (version.startsWith("1."))
    return { from: "#14b8a6", to: "#10b981", badge: "teal" };
  if (version.startsWith("2."))
    return { from: "#8b5cf6", to: "#a855f7", badge: "violet" };
  return { from: "#64748b", to: "#94a3b8", badge: "gray" };
}

const icons = [IconRocket, IconSparkles, IconGitBranch];

export function ChangeLogTimeline({ changelogs }: { changelogs: ChangeLog[] }) {
  return (
    <div style={{ position: "relative" }}>
      {/* Timeline line */}
      <div
        style={{
          position: "absolute",
          left: 19,
          top: 20,
          bottom: 20,
          width: 2,
          background: "rgba(255, 255, 255, 0.1)",
        }}
      />

      <Stack gap={24}>
        {changelogs.map((entry, index) => {
          const Icon = icons[index % icons.length];
          const colors = getVersionColor(entry?.version || "0.0.0");

          return (
            <Flex key={entry.id} gap={24} align="flex-start">
              {/* Timeline bullet */}
              <div
                style={{
                  width: 40,
                  height: 40,
                  borderRadius: "50%",
                  background: `linear-gradient(135deg, ${colors.from}, ${colors.to})`,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  color: "#ffffff",
                  flexShrink: 0,
                  position: "relative",
                  zIndex: 1,
                }}
              >
                <Icon size={20} stroke={1.5} />
              </div>

              {/* Content card */}
              <Paper
                p="lg"
                radius="lg"
                style={{
                  flex: 1,
                  background: "rgba(255, 255, 255, 0.02)",
                  border: "1px solid rgba(255, 255, 255, 0.06)",
                }}
              >
                <Flex
                  justify="space-between"
                  align="center"
                  mb="sm"
                  wrap="wrap"
                  gap="sm"
                >
                  <Badge
                    size="lg"
                    variant="light"
                    color={colors.badge}
                    radius="sm"
                    style={{ fontFamily: "monospace" }}
                  >
                    v{entry.version}
                  </Badge>
                  <Flex gap={6} align="center" style={{ color: "#64748b" }}>
                    <IconCalendar size={14} />
                    <Text
                      size="sm"
                      title={dayjs(entry.createdAt).format("MMMM D, YYYY")}
                      style={{ color: "#64748b" }}
                    >
                      {dayjs(entry.createdAt).fromNow()}
                    </Text>
                  </Flex>
                </Flex>

                <div
                  style={{
                    borderTop: "1px solid rgba(255, 255, 255, 0.06)",
                    margin: "12px 0",
                  }}
                />

                {entry.body ? (
                  <div
                    style={{
                      color: "#94a3b8",
                      lineHeight: 1.7,
                    }}
                    dangerouslySetInnerHTML={{
                      __html: marked.parse(entry.body) as string,
                    }}
                  />
                ) : (
                  <Text size="sm" fs="italic" style={{ color: "#64748b" }}>
                    No description provided for this release.
                  </Text>
                )}

                <Text size="xs" mt="md" style={{ color: "#64748b" }}>
                  Published {dayjs(entry.publishedAt).format("MMMM D, YYYY")}
                </Text>
              </Paper>
            </Flex>
          );
        })}
      </Stack>
    </div>
  );
}
