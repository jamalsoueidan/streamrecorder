"use server";

import {
  FollowerTypeEnum,
  FollowRequestBody,
  ScopeEnum,
} from "@/lib/types/strapi-autogenerated";
import api from "../../lib/api";
import { SortOptions } from "../lib/types/filtering";

export async function follow(prevState: any, formData: FormData) {
  const username = formData.get("username") as string;
  const type = formData.get("type") as FollowerTypeEnum;

  try {
    await api.follower.followCreate({
      username,
      type,
    });

    return { success: true };
  } catch (err: any) {
    return { error: err.response?.data?.error?.message || "Failed to follow" };
  }
}

export async function followUser(data: FollowRequestBody) {
  try {
    await api.follower.followCreate(data);

    return { success: true };
  } catch (err: any) {
    return { error: err.response?.data?.error?.message || "Failed to follow" };
  }
}

export async function unfollow(id: number) {
  try {
    await api.follower.unfollowDelete({ id });

    return { success: true };
  } catch (err: any) {
    return {
      error: err.response?.data?.error?.message || "Failed to unfollow",
    };
  }
}

export async function getFollowers({
  scope,
  page,
  sort = SortOptions.createdAtAsc,
}: {
  scope: ScopeEnum;
  page: number;
  sort: SortOptions;
}) {
  const response = await api.follower.browseFollowers({
    scope,
    hasRecordings: true,
    "pagination[page]": page,
    "pagination[pageSize]": 10,
    populate: {
      recordings: {
        populate: {
          sources: {
            fields: ["*"],
          },
        },
      },
    },
    sort,
  });

  return {
    data: response.data?.data || [],
    meta: response.data?.meta,
  };
}
