"use client";

import { useState, useTransition } from "react";
import { getFollowersData } from "@/app/actions/followers";
import { ScopeEnum, FollowRequestBodyTypeEnum, FollowerWithMeta } from "@/lib/types/strapi-autogenerated";
import FollowButton from "./follow-button";
import UnfollowButton from "./unfollow-button";

type Props = {
  initialData: FollowerWithMeta[];
  initialScope: ScopeEnum | "all";
};

export default function Followings({ initialData, initialScope }: Props) {
  const [data, setData] = useState(initialData);
  const [scope, setScope] = useState(initialScope);
  const [isPending, startTransition] = useTransition();

  const loadData = (newScope?: ScopeEnum | "all") => {
    const targetScope = newScope ?? scope;
    startTransition(async () => {
      const result = await getFollowersData(targetScope);
      setData(result);
      if (newScope) setScope(newScope);
    });
  };

  return (
    <section>
      <header style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
        <h2>Followers ({data.length})</h2>
        <div>
          <select
            value={scope}
            onChange={(e) => loadData(e.target.value as ScopeEnum | "all")}
          >
            <option value={ScopeEnum.Following}>Following</option>
            <option value={ScopeEnum.Discover}>Discover</option>
            <option value="all">All</option>
          </select>
          {isPending && <span> Loading...</span>}
        </div>
      </header>

      {data.length === 0 ? (
        <p>
          {scope === ScopeEnum.Following
            ? "You're not following anyone yet."
            : scope === ScopeEnum.Discover
            ? "No more accounts to discover."
            : "No followers found."}
        </p>
      ) : (
        <ul style={{ listStyle: "none", padding: 0 }}>
          {data.map((f) => (
            <li key={f.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
              <div>
                <strong>{f.username}</strong> <span>@{f.slug}</span>
                <br />
                <small>{f.totalRecordings} recordings</small>
              </div>
              {f.isFollowing ? (
                <UnfollowButton id={f.id!} onSuccess={() => loadData()} />
              ) : (
                <FollowButton username={f.username!} slug={f.slug!} type={f.type as unknown as FollowRequestBodyTypeEnum} onSuccess={() => loadData()} />
              )}
            </li>
          ))}
        </ul>
      )}
    </section>
  );
}
