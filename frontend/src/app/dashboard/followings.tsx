"use client";

import { useActionState } from "react";
import { getFollowers, FollowersState } from "@/app/actions/followers";
import { ScopeEnum } from "@/lib/types/strapi-autogenerated";
import FollowButton from "./follow-button";
import UnfollowButton from "./unfollow-button";

type Props = {
  initialState: FollowersState;
};

export default function Followings({ initialState }: Props) {
  const [state, formAction, pending] = useActionState(getFollowers, initialState);

  const followers = state?.data?.data || [];

  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
        <h2>Followers ({followers.length})</h2>
        <form action={formAction} style={{ display: "flex", gap: 8, alignItems: "center" }}>
          <select
            name="scope"
            defaultValue={state?.scope || ScopeEnum.Following}
            onChange={(e) => e.currentTarget.form?.requestSubmit()}
            style={{ padding: 8, borderRadius: 4 }}
          >
            <option value={ScopeEnum.Following}>Following</option>
            <option value={ScopeEnum.Discover}>Discover</option>
            <option value="all">All</option>
          </select>
          {pending && <span style={{ color: "#666", fontSize: 12 }}>Loading...</span>}
        </form>
      </div>

      {followers.length === 0 ? (
        <p style={{ color: "#666" }}>
          {state?.scope === ScopeEnum.Following
            ? "You're not following anyone yet."
            : state?.scope === ScopeEnum.Discover
            ? "No more accounts to discover."
            : "No followers found."}
        </p>
      ) : (
        <ul style={{ listStyle: "none", padding: 0 }}>
          {followers.map((f) => (
            <li
              key={f.id}
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                padding: 12,
                border: "1px solid #eee",
                marginBottom: 8,
                borderRadius: 8,
              }}
            >
              <div>
                <strong>{f.username}</strong>{" "}
                <span style={{ color: "#666", fontSize: 12 }}>@{f.slug}</span>
                <br />
                <small style={{ color: "#999" }}>{f.totalRecordings} recordings</small>
              </div>
              {f.isFollowing ? (
                <UnfollowButton id={f.id!} />
              ) : (
                <FollowButton username={f.username} slug={f.slug} type={f.type} />
              )}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
