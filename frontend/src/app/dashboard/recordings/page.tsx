import api from "@/app/api";
import { FollowerTypeEnum, ScopeEnum } from "@/lib/types/strapi-autogenerated";
import FollowButton from "../follow-button";
import ScopeFilter from "../scope-filter";

type Props = {
  searchParams: Promise<{ scope?: string }>;
};

export default async function RecordingsPage({ searchParams }: Props) {
  const { scope: scopeParam } = await searchParams;
  const scope = scopeParam || "all";

  const response = await api.recording.browseRecordings(
    scope === "all"
      ? { populate: "*" }
      : { scope: scope as ScopeEnum, populate: "*" }
  );

  const data = response.data?.data || [];

  return (
    <section>
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: 16,
        }}
      >
        <h2>Recordings ({data.length})</h2>
        <ScopeFilter currentScope={scope} />
      </div>

      {data.length === 0 ? (
        <p>
          {scope === ScopeEnum.Following
            ? "No recordings from followed accounts."
            : scope === ScopeEnum.Discover
            ? "No recordings to discover."
            : "No recordings found."}
        </p>
      ) : (
        <ul style={{ listStyle: "none", padding: 0 }}>
          {data.map((r) => (
            <li key={r.id} style={{ marginBottom: 12 }}>
              <div style={{ display: "flex", justifyContent: "space-between" }}>
                <span>
                  <strong>{r.follower?.username}</strong>
                </span>
                {r.follower && scope !== ScopeEnum.Following && (
                  <FollowButton
                    username={r.follower.username || ""}
                    type={r.follower.type || FollowerTypeEnum.Tiktok}
                  />
                )}
              </div>
              <small>
                {r.createdAt
                  ? new Date(r.createdAt).toLocaleString()
                  : "Unknown date"}
              </small>
              {r.sources && r.sources.length > 0 && (
                <ul style={{ marginTop: 4 }}>
                  {r.sources.map((s) => (
                    <li key={s.id}>
                      <a
                        href={s.path || "#"}
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        {s.path?.split("/").pop() || "View"}
                      </a>
                      {s.duration && (
                        <span>
                          {" "}
                          ({Math.floor(s.duration / 60)}m {s.duration % 60}s)
                        </span>
                      )}
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))}
        </ul>
      )}
    </section>
  );
}
