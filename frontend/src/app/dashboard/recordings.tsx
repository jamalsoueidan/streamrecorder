"use client";

import { useActionState } from "react";
import { getRecordings, RecordingsState } from "@/app/actions/recordings";
import { ScopeEnum } from "@/lib/types/strapi-autogenerated";
import FollowButton from "./follow-button";

type Props = {
  initialState: RecordingsState;
};

export default function Recordings({ initialState }: Props) {
  const [state, formAction, pending] = useActionState(getRecordings, initialState);

  const recordings = state?.data?.data || [];

  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
        <h2>Recordings ({recordings.length})</h2>
        <form action={formAction} style={{ display: "flex", gap: 8, alignItems: "center" }}>
          <select
            name="scope"
            defaultValue={state?.scope || ScopeEnum.Following}
            onChange={(e) => e.currentTarget.form?.requestSubmit()}
            style={{ padding: 8, borderRadius: 4 }}
          >
            <option value={ScopeEnum.Following}>Following</option>
            <option value={ScopeEnum.Discover}>Discover</option>
            <option value="all">All</option>
          </select>
          {pending && <span style={{ color: "#666", fontSize: 12 }}>Loading...</span>}
        </form>
      </div>

      {recordings.length === 0 ? (
        <p style={{ color: "#666" }}>
          {state?.scope === ScopeEnum.Following
            ? "No recordings from followed accounts."
            : state?.scope === ScopeEnum.Discover
            ? "No recordings to discover."
            : "No recordings found."}
        </p>
      ) : (
        <ul style={{ listStyle: "none", padding: 0 }}>
          {recordings.map((r) => (
            <li
              key={r.id}
              style={{
                padding: 12,
                border: "1px solid #eee",
                marginBottom: 8,
                borderRadius: 8,
              }}
            >
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
                <div>
                  <strong>{r.follower?.username}</strong>{" "}
                  <span style={{ color: "#666", fontSize: 12 }}>@{r.follower?.slug}</span>
                </div>
                {r.follower && state?.scope !== ScopeEnum.Following && (
                  <FollowButton
                    username={r.follower.username || ""}
                    slug={r.follower.slug || ""}
                    type={r.follower.type || "tiktok"}
                  />
                )}
              </div>
              <div style={{ fontSize: 12, color: "#999", marginBottom: 8 }}>
                {r.createdAt ? new Date(r.createdAt).toLocaleString() : "Unknown date"}
              </div>
              {r.sources && r.sources.length > 0 && (
                <div>
                  <small style={{ color: "#666" }}>{r.sources.length} source(s)</small>
                  <ul style={{ margin: "8px 0", paddingLeft: 20 }}>
                    {r.sources.map((s) => (
                      <li key={s.id} style={{ fontSize: 12 }}>
                        <a
                          href={s.path || "#"}
                          target="_blank"
                          rel="noopener noreferrer"
                          style={{ color: "#0066cc" }}
                        >
                          {s.path?.split("/").pop() || "View"}
                        </a>
                        {s.duration && (
                          <span style={{ color: "#999", marginLeft: 8 }}>
                            {Math.floor(s.duration / 60)}m {s.duration % 60}s
                          </span>
                        )}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
