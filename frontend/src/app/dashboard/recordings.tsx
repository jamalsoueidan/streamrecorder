"use client";

import { useActionState, useRef } from "react";
import { getRecordings, RecordingsState } from "@/app/actions/recordings";
import { ScopeEnum, FollowRequestBodyTypeEnum } from "@/lib/types/strapi-autogenerated";
import FollowButton from "./follow-button";

type Props = {
  initialState: RecordingsState;
};

export default function Recordings({ initialState }: Props) {
  const [state, formAction, pending] = useActionState(getRecordings, initialState);
  const formRef = useRef<HTMLFormElement>(null);

  const scope = state?.scope || initialState.scope;
  const recordings = state?.data?.data || [];

  const refresh = () => formRef.current?.requestSubmit();

  return (
    <section>
      <header style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
        <h2>Recordings ({recordings.length})</h2>
        <form ref={formRef} action={formAction}>
          <select
            key={scope}
            name="scope"
            defaultValue={scope}
            onChange={(e) => e.currentTarget.form?.requestSubmit()}
          >
            <option value={ScopeEnum.Following}>Following</option>
            <option value={ScopeEnum.Discover}>Discover</option>
            <option value="all">All</option>
          </select>
          {pending && <span> Loading...</span>}
        </form>
      </header>

      {recordings.length === 0 ? (
        <p>
          {scope === ScopeEnum.Following
            ? "No recordings from followed accounts."
            : scope === ScopeEnum.Discover
            ? "No recordings to discover."
            : "No recordings found."}
        </p>
      ) : (
        <ul style={{ listStyle: "none", padding: 0 }}>
          {recordings.map((r) => (
            <li key={r.id} style={{ marginBottom: 12 }}>
              <div style={{ display: "flex", justifyContent: "space-between" }}>
                <span>
                  <strong>{r.follower?.username}</strong> @{r.follower?.slug}
                </span>
                {r.follower && scope !== ScopeEnum.Following && (
                  <FollowButton
                    username={r.follower.username || ""}
                    slug={r.follower.slug || ""}
                    type={(r.follower.type || "tiktok") as FollowRequestBodyTypeEnum}
                    onSuccess={refresh}
                  />
                )}
              </div>
              <small>{r.createdAt ? new Date(r.createdAt).toLocaleString() : "Unknown date"}</small>
              {r.sources && r.sources.length > 0 && (
                <ul style={{ marginTop: 4 }}>
                  {r.sources.map((s) => (
                    <li key={s.id}>
                      <a href={s.path || "#"} target="_blank" rel="noopener noreferrer">
                        {s.path?.split("/").pop() || "View"}
                      </a>
                      {s.duration && (
                        <span> ({Math.floor(s.duration / 60)}m {s.duration % 60}s)</span>
                      )}
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))}
        </ul>
      )}
    </section>
  );
}
