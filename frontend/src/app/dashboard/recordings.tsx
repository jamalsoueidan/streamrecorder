"use client";

import { useActionState } from "react";
import { getRecordings, RecordingsState } from "@/app/actions/recordings";
import { ScopeEnum } from "@/lib/types/strapi-autogenerated";
import FollowButton from "./follow-button";

type Props = {
  initialState: RecordingsState;
};

export default function Recordings({ initialState }: Props) {
  const [state, formAction, pending] = useActionState(getRecordings, initialState);

  const recordings = state?.data?.data || [];

  return (
    <section>
      <header>
        <h2>Recordings ({recordings.length})</h2>
        <form action={formAction}>
          <select
            name="scope"
            defaultValue={state?.scope || ScopeEnum.Following}
            onChange={(e) => e.currentTarget.form?.requestSubmit()}
          >
            <option value={ScopeEnum.Following}>Following</option>
            <option value={ScopeEnum.Discover}>Discover</option>
            <option value="all">All</option>
          </select>
          {pending && <span>Loading...</span>}
        </form>
      </header>

      {recordings.length === 0 ? (
        <p>
          {state?.scope === ScopeEnum.Following
            ? "No recordings from followed accounts."
            : state?.scope === ScopeEnum.Discover
            ? "No recordings to discover."
            : "No recordings found."}
        </p>
      ) : (
        <ul>
          {recordings.map((r) => (
            <li key={r.id}>
              <div>
                <strong>{r.follower?.username}</strong> <span>@{r.follower?.slug}</span>
                {r.follower && state?.scope !== ScopeEnum.Following && (
                  <FollowButton
                    username={r.follower.username || ""}
                    slug={r.follower.slug || ""}
                    type={r.follower.type || "tiktok"}
                  />
                )}
              </div>
              <div>
                {r.createdAt ? new Date(r.createdAt).toLocaleString() : "Unknown date"}
              </div>
              {r.sources && r.sources.length > 0 && (
                <div>
                  <small>{r.sources.length} source(s)</small>
                  <ul>
                    {r.sources.map((s) => (
                      <li key={s.id}>
                        <a href={s.path || "#"} target="_blank" rel="noopener noreferrer">
                          {s.path?.split("/").pop() || "View"}
                        </a>
                        {s.duration && (
                          <span>
                            {Math.floor(s.duration / 60)}m {s.duration % 60}s
                          </span>
                        )}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </li>
          ))}
        </ul>
      )}
    </section>
  );
}
