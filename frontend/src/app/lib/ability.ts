// lib/ability.ts
import { UsersPermissionsPermissionsTree } from "@/lib/types/strapi-autogenerated";
import { createMongoAbility, MongoAbility, RawRuleOf } from "@casl/ability";

export type AppAbility = MongoAbility;
export type AppRules = RawRuleOf<AppAbility>[];

export function buildRulesFromStrapi(
  permissions: UsersPermissionsPermissionsTree
): AppRules {
  const rules: AppRules = [];

  Object.entries(permissions).forEach(([resource, data]) => {
    const rawSubject = resource.split("::")[1] || resource;
    const subject = rawSubject
      .split("-")
      .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
      .join("");

    if (data.controllers) {
      Object.entries(data.controllers).forEach(([_controller, actions]) => {
        Object.entries(actions).forEach(([action, config]) => {
          if (config.enabled) {
            rules.push({ action, subject });
          }
        });
      });
    }
  });

  return rules;
}

export function createAbility(rules: AppRules): AppAbility {
  return createMongoAbility(rules);
}
