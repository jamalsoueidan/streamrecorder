import { FollowerTypeIcon } from "@/app/[locale]/(protected)/components/follower-type-icon";
import { ImageSpritePreview } from "@/app/[locale]/(protected)/components/image-sprite-preview";
import { getProfileUrl } from "@/app/components/open-social";
import { generateAvatarUrl } from "@/app/lib/avatar-url";
import { streamingPlatforms } from "@/app/lib/streaming-platforms";
import { FollowerTypeEnum, ScopeEnum } from "@/lib/types/strapi-autogenerated";
import {
  Anchor,
  Avatar,
  Box,
  Button,
  Card,
  Divider,
  Flex,
  Image,
  SimpleGrid,
  Stack,
  Text,
  Title,
} from "@mantine/core";
import {
  IconBrandSafari,
  IconChevronRight,
  IconLayoutDashboard,
  IconVideo,
  IconWorldSearch,
} from "@tabler/icons-react";
import { getTranslations } from "next-intl/server";
import NextImage from "next/image";
import Link from "next/link";
import {
  fetchLatestFollowers,
  fetchRecordingsByPlatform,
} from "./actions/fetch-recordings";

const platformMap: Record<string, FollowerTypeEnum> = {
  TikTok: FollowerTypeEnum.Tiktok,
  Twitch: FollowerTypeEnum.Twitch,
  Kick: FollowerTypeEnum.Kick,
  YouTube: FollowerTypeEnum.Youtube,
  AfreecaTV: FollowerTypeEnum.Afreecatv,
  Pandalive: FollowerTypeEnum.Pandalive,
  Bigo: FollowerTypeEnum.Bigo,
};

export default async function Page() {
  const t = await getTranslations("protected.dashboard");

  const [latestFollowers, myFeed, platformDataRaw] = await Promise.all([
    fetchLatestFollowers(),
    Promise.all(
      streamingPlatforms.map(async (platform) => {
        const type = platformMap[platform.name];
        const recordings = await fetchRecordingsByPlatform(
          ScopeEnum.Following,
          type,
        );
        return {
          ...platform,
          type,
          recordings,
        };
      }),
    ),
    Promise.all(
      streamingPlatforms.map(async (platform) => {
        const type = platformMap[platform.name];
        const recordings = await fetchRecordingsByPlatform(
          ScopeEnum.Discover,
          type,
        );
        return {
          ...platform,
          type,
          recordings,
        };
      }),
    ),
  ]);

  // Filter out platforms with no recordings
  const platformData = platformDataRaw.filter(
    (platform) => platform.recordings.length > 0,
  );

  return (
    <Stack w="100%">
      <Flex justify="space-between" align="center" w="100%">
        <Stack gap={2}>
          <Flex gap="xs" align="center">
            <IconLayoutDashboard size={32} />
            <Title order={1} size="h3">
              {t("title")}
            </Title>
          </Flex>
          <Text size="xs" c="dimmed">
            {t("description")}
          </Text>
        </Stack>
      </Flex>

      <Stack gap="md">
        <Divider mx={{ base: "-xs", sm: "-md" }} />
        <Box
          bg="gray.9"
          mx={{ base: "-xs", sm: "-md" }}
          my="-md"
          py="sm"
          px={{ base: "xs", sm: "md" }}
        >
          <Flex justify="space-between" align="center" w="100%">
            <Stack gap={2}>
              <Flex gap="xs" align="center">
                <IconWorldSearch size={24} />
                <Title order={1} size="lg">
                  {t("newCreators")}
                </Title>
              </Flex>
            </Stack>
          </Flex>
        </Box>
        <Divider mx={{ base: "-xs", sm: "-md" }} />

        <Flex gap={20} wrap="wrap">
          {latestFollowers.map((follower) => (
            <div
              key={follower.documentId}
              style={{
                flex: "1 1 calc(16.666% - 17px)",
                minWidth: "140px",
                maxWidth: "180px",
              }}
            >
              <Anchor href={getProfileUrl(follower)} underline="never">
                <Card
                  padding={16}
                  style={{
                    background: "rgba(255, 255, 255, 0.02)",
                    border: "1px solid rgba(255, 255, 255, 0.06)",
                    borderRadius: "16px",
                    cursor: "pointer",
                    textAlign: "center",
                  }}
                >
                  <Stack align="center" gap={8}>
                    <div style={{ position: "relative" }}>
                      <Avatar size={64} radius="xl">
                        <NextImage
                          src={generateAvatarUrl(follower.avatar?.url)}
                          alt={follower.username}
                          width={64}
                          height={64}
                          quality={75}
                        />
                      </Avatar>
                      <FollowerTypeIcon
                        pos="absolute"
                        color="transparent"
                        type={follower.type}
                        top="50%"
                        left="50%"
                        size={32}
                        opacity={0.8}
                        style={{ transform: "translate(-50%, -50%)" }}
                      />
                    </div>
                    <div>
                      <Text fw={600} size="sm" style={{ color: "#f1f5f9" }}>
                        {follower.nickname || follower.username}
                      </Text>
                      <Text size="xs" style={{ color: "#64748b" }}>
                        @{follower.username}
                      </Text>
                    </div>
                  </Stack>
                </Card>
              </Anchor>
            </div>
          ))}
        </Flex>
      </Stack>

      {myFeed.length > 0 && (
        <>
          <Divider mx={{ base: "-xs", sm: "-md" }} />
          <Box
            bg="gray.9"
            mx={{ base: "-xs", sm: "-md" }}
            my="-md"
            py="sm"
            px={{ base: "xs", sm: "md" }}
          >
            <Flex justify="space-between" align="center" w="100%">
              <Stack gap={2}>
                <Flex gap="xs" align="center">
                  <IconVideo size={24} />
                  <Title order={1} size="lg">
                    {t("myFeed")}
                  </Title>
                </Flex>
              </Stack>
            </Flex>
          </Box>
          <Divider mx={{ base: "-xs", sm: "-md" }} />

          {myFeed.map((platform) =>
            platform.recordings.length > 0 ? (
              <Stack key={platform.name} gap="md">
                <Flex justify="space-between" align="center">
                  <Flex gap="xs" align="center">
                    <Image
                      src={platform.file}
                      alt={platform.name}
                      w={24}
                      h={24}
                      style={{ filter: "brightness(0) invert(1)" }}
                    />
                    <Title order={2} size="h4">
                      {platform.name}
                    </Title>
                  </Flex>
                  <Link href={`/explore?type=${platform.type}`}>
                    <Button
                      variant="subtle"
                      color="gray"
                      size="compact-sm"
                      rightSection={<IconChevronRight size={16} />}
                    >
                      {t("browseAll")}
                    </Button>
                  </Link>
                </Flex>

                <SimpleGrid cols={{ base: 2, sm: 2, md: 4 }} spacing="md">
                  {platform.recordings.map((rec) => (
                    <ImageSpritePreview
                      key={rec.documentId}
                      recording={rec}
                      username={rec.follower?.username || ""}
                      type={platform.type}
                    />
                  ))}
                </SimpleGrid>

                <Divider />
              </Stack>
            ) : null,
          )}
        </>
      )}

      <Divider mx={{ base: "-xs", sm: "-md" }} />
      <Box
        bg="gray.9"
        mx={{ base: "-xs", sm: "-md" }}
        my="-md"
        py="sm"
        px={{ base: "xs", sm: "md" }}
      >
        <Flex justify="space-between" align="center" w="100%">
          <Stack gap={2}>
            <Flex gap="xs" align="center">
              <IconBrandSafari size={24} />
              <Title order={1} size="lg">
                {t("discoverSection")}
              </Title>
            </Flex>
          </Stack>
        </Flex>
      </Box>
      <Divider mx={{ base: "-xs", sm: "-md" }} />

      {platformData.map((platform) => (
        <Stack key={platform.name} gap="md">
          <Flex justify="space-between" align="center">
            <Flex gap="xs" align="center">
              <Image
                src={platform.file}
                alt={platform.name}
                w={24}
                h={24}
                style={{ filter: "brightness(0) invert(1)" }}
              />
              <Title order={2} size="h4">
                {platform.name}
              </Title>
            </Flex>
            <Link href={`/explore?type=${platform.type}`}>
              <Button
                variant="subtle"
                color="gray"
                size="compact-sm"
                rightSection={<IconChevronRight size={16} />}
              >
                {t("browseAll")}
              </Button>
            </Link>
          </Flex>

          <SimpleGrid cols={{ base: 2, sm: 2, md: 4 }} spacing="md">
            {platform.recordings.map((rec) => (
              <ImageSpritePreview
                key={rec.documentId}
                recording={rec}
                username={rec.follower?.username || ""}
                type={platform.type}
              />
            ))}
          </SimpleGrid>

          <Divider />
        </Stack>
      ))}
    </Stack>
  );
}
