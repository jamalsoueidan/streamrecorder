"use server";

import api from "@/lib/api";
import { FollowerTypeEnum, ScopeEnum } from "@/lib/types/strapi-autogenerated";

const basePopulate = {
  sources: {
    fields: ["*"],
    filters: {
      state: {
        $eq: "done",
      },
    },
  },
  follower: {
    fields: ["username", "type"],
    populate: {
      avatar: {
        fields: ["url"],
      },
    },
  },
};

const baseFilters = {
  sources: {
    state: {
      $eq: ["done"],
    },
  },
};

export async function fetchRecordingsByPlatform(
  scope: ScopeEnum,
  platform: FollowerTypeEnum,
) {
  const response = await api.recording.browseRecordings({
    scope,
    filters: {
      ...baseFilters,
      follower: {
        type: { $eq: platform },
      },
    },
    populate: basePopulate,
    sort: "updatedAt:desc",
    "pagination[page]": 1,
    "pagination[pageSize]": 4,
  });

  return response.data?.data || [];
}

export async function fetchLatestFollowers() {
  const response = await api.follower.getFollowers({
    sort: "createdAt:desc",
    "pagination[page]": 1,
    "pagination[pageSize]": 6,
    populate: ["avatar"],
  });

  return response.data?.data || [];
}
