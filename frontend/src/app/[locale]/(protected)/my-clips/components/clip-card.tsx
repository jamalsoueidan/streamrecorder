"use client";

import { ClipWithShare } from "@/lib/types/strapi-autogenerated";
import {
  Badge,
  Button,
  Card,
  Flex,
  Group,
  Loader,
  Stack,
  Title,
} from "@mantine/core";
import { notifications } from "@mantine/notifications";
import {
  IconBrandTiktok,
  IconCheck,
  IconEdit,
  IconTrash,
} from "@tabler/icons-react";
import { useTranslations } from "next-intl";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useState } from "react";
import { checkTikTokStatus } from "../actions/share-tiktok";
import { ClipPreview } from "./clip-preview";

interface ClipCardProps {
  clip: ClipWithShare;
  locale: string;
}

export function ClipCard({ clip, locale }: ClipCardProps) {
  const t = useTranslations("protected.myClips");
  const router = useRouter();
  const [checking, setChecking] = useState(false);

  const clipShare = clip.clipShare;
  const shareState = clipShare?.state;
  const publishId = (clipShare?.data as { publishId?: string })?.publishId;

  // Hidden admin feature: click badge to check TikTok status
  const handleBadgeClick = async () => {
    if (!publishId || checking) return;
    setChecking(true);
    const result = await checkTikTokStatus(publishId);
    setChecking(false);

    notifications.show({
      title: "TikTok Status",
      message: `Status: ${result.status}${result.postId ? ` | Post ID: ${result.postId}` : ""}${result.error ? ` | Error: ${result.error}` : ""}`,
      color:
        result.status === "PUBLISH_COMPLETE"
          ? "green"
          : result.status === "FAILED"
            ? "red"
            : "blue",
    });

    router.refresh();
  };

  const renderTikTokStatus = () => {
    if (shareState === "processing") {
      return (
        <Button
          size="md"
          variant="light"
          color="green"
          leftSection={<IconCheck size={18} />}
          fullWidth
          disabled
        >
          {t("share.uploaded")}
        </Button>
      );
    }

    if (shareState === "completed") {
      return (
        <Button
          size="md"
          variant="light"
          color="green"
          leftSection={<IconCheck size={18} />}
          fullWidth
          disabled
        >
          {t("share.uploaded")}
        </Button>
      );
    }

    if (shareState === "failed") {
      return (
        <Button
          component={Link}
          href={`/my-clips/${clip.documentId}/publish`}
          size="md"
          variant="filled"
          color="red"
          leftSection={<IconBrandTiktok size={18} />}
          fullWidth
        >
          {t("share.retry")}
        </Button>
      );
    }

    // No share yet - big obvious button
    return (
      <Button
        component={Link}
        href={`/my-clips/${clip.documentId}/publish`}
        size="md"
        variant="filled"
        leftSection={<IconBrandTiktok size={18} />}
        fullWidth
      >
        {t("share.tiktok")}
      </Button>
    );
  };

  return (
    <Card radius="md" withBorder>
      <Stack gap="sm">
        {/* Title and badge above video */}
        <Flex justify="space-between" align="center">
          <Title order={4} lineClamp={1}>
            {clip.title}
          </Title>
          <Badge
            size="lg"
            variant="light"
            style={{ cursor: publishId ? "pointer" : "default" }}
            onClick={handleBadgeClick}
          >
            {checking ? <Loader size={12} /> : `${clip.viral_score}/100`}
          </Badge>
        </Flex>

        {/* Video */}
        <ClipPreview clip={clip} type={clip.follower?.type} locale={locale} />

        {/* Action buttons */}
        <Stack gap="xs">
          {renderTikTokStatus()}

          <Group grow>
            <Button
              size="sm"
              variant="light"
              color="gray"
              leftSection={<IconEdit size={16} />}
            >
              {t("actions.edit")}
            </Button>
            <Button
              size="sm"
              variant="light"
              color="red"
              leftSection={<IconTrash size={16} />}
            >
              {t("actions.delete")}
            </Button>
          </Group>
        </Stack>
      </Stack>
    </Card>
  );
}
