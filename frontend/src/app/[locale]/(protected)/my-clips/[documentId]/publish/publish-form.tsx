"use client";

import { Clip } from "@/lib/types/strapi-autogenerated";
import {
  Alert,
  AspectRatio,
  Avatar,
  Button,
  Card,
  Checkbox,
  Divider,
  Grid,
  Group,
  Loader,
  Select,
  Stack,
  Switch,
  Text,
  TextInput,
  Title,
} from "@mantine/core";
import { useForm } from "@mantine/form";
import { notifications } from "@mantine/notifications";
import {
  IconAlertCircle,
  IconArrowLeft,
  IconBrandTiktok,
  IconLock,
} from "@tabler/icons-react";
import { useTranslations } from "next-intl";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useEffect, useRef, useState } from "react";
import {
  CreatorInfo,
  getCreatorInfo,
  shareToTikTok,
} from "../../actions/share-tiktok";

interface PublishFormProps {
  clip: Clip;
  videoUrl: string;
}

export function PublishForm({ clip, videoUrl }: PublishFormProps) {
  const t = useTranslations("protected.myClips.publishPage");
  const router = useRouter();
  const videoRef = useRef<HTMLVideoElement>(null);
  const [loading, setLoading] = useState(false);
  const [creatorInfo, setCreatorInfo] = useState<CreatorInfo | null>(null);
  const [loadingCreator, setLoadingCreator] = useState(true);
  const [creatorError, setCreatorError] = useState<string | null>(null);

  const form = useForm({
    initialValues: {
      description: (clip.title || "").substring(0, 150),
      privacyLevel: "",
      allowComments: false,
      allowDuet: false,
      allowStitch: false,
      brandContentToggle: false,
      brandOrganicToggle: false,
      musicConfirmation: false,
    },
    validate: {
      privacyLevel: (value) =>
        !value ? t("validation.privacyRequired") : null,
      musicConfirmation: (value) =>
        !value ? t("validation.musicConfirmationRequired") : null,
    },
  });

  // Fetch creator info on mount
  useEffect(() => {
    getCreatorInfo().then((result) => {
      setLoadingCreator(false);
      if (result.success && result.data) {
        setCreatorInfo(result.data);
      } else {
        setCreatorError(result.error || "Failed to load creator info");
      }
    });
  }, []);

  const handleSubmit = async (values: typeof form.values) => {
    if (!clip.documentId) return;

    setLoading(true);
    const result = await shareToTikTok({
      clipDocumentId: clip.documentId,
      title: values.description,
      privacyLevel: values.privacyLevel,
      allowComments: values.allowComments,
      allowDuet: values.allowDuet,
      allowStitch: values.allowStitch,
      brandContentToggle: values.brandContentToggle,
      brandOrganicToggle: values.brandOrganicToggle,
    });
    setLoading(false);

    if (result.success) {
      notifications.show({
        title: t("success"),
        message: t("successMessage"),
        color: "green",
      });
      router.push("/my-clips");
    } else {
      notifications.show({
        title: t("error"),
        message: result.error,
        color: "red",
      });
    }
  };

  // Build privacy options from creator info
  const privacyOptions =
    creatorInfo?.privacy_level_options.map((level) => ({
      value: level,
      label: t(`privacy.${level}`),
    })) || [];

  if (loadingCreator) {
    return (
      <Stack align="center" py="xl">
        <Loader size="lg" />
        <Text c="dimmed">{t("loadingCreator")}</Text>
      </Stack>
    );
  }

  if (creatorError) {
    return (
      <Stack gap="md">
        <Alert icon={<IconAlertCircle size={16} />} color="red">
          {creatorError}
        </Alert>
        <Button
          component={Link}
          href="/my-clips"
          variant="light"
          leftSection={<IconArrowLeft size={16} />}
        >
          {t("backToClips")}
        </Button>
      </Stack>
    );
  }

  return (
    <form onSubmit={form.onSubmit(handleSubmit)}>
      <Grid gutter="xl">
        {/* Right side - Form */}
        <Grid.Col span={{ base: 12, md: 8 }}>
          <Stack gap="lg">
            {/* Creator Info - Publishing to this account */}
            {creatorInfo && (
              <Card withBorder radius="md" p="md">
                <Group gap="sm">
                  <Avatar
                    src={creatorInfo.creator_avatar_url}
                    size="lg"
                    radius="xl"
                  />
                  <Stack gap={2}>
                    <Text size="xs" c="dimmed">
                      {t("publishingTo")}
                    </Text>
                    <Text size="md" fw={600}>
                      {creatorInfo.creator_nickname}
                    </Text>
                    <Text size="sm" c="dimmed">
                      @{creatorInfo.creator_username}
                    </Text>
                  </Stack>
                </Group>
              </Card>
            )}

            {/* Description */}
            <TextInput
              label={t("descriptionLabel")}
              placeholder={t("descriptionPlaceholder")}
              maxLength={150}
              size="md"
              rightSection={
                <Text size="xs" c="dimmed" pr="xs">
                  {form.values.description.length}/150
                </Text>
              }
              rightSectionWidth={60}
              {...form.getInputProps("description")}
            />

            <Divider />

            {/* Privacy Level */}
            <Select
              label={t("privacyLabel")}
              placeholder={t("privacyPlaceholder")}
              data={privacyOptions}
              size="md"
              leftSection={<IconLock size={16} />}
              withAsterisk
              {...form.getInputProps("privacyLevel")}
            />

            <Divider />

            {/* Interaction Settings */}
            <Stack gap="sm">
              <Title order={5}>{t("interactionSettings")}</Title>

              <Switch
                label={t("allowComments")}
                size="md"
                disabled={creatorInfo?.comment_disabled}
                {...form.getInputProps("allowComments", { type: "checkbox" })}
              />

              <Switch
                label={t("allowDuet")}
                size="md"
                disabled={creatorInfo?.duet_disabled}
                description={
                  creatorInfo?.duet_disabled
                    ? t("disabledByCreator")
                    : undefined
                }
                {...form.getInputProps("allowDuet", { type: "checkbox" })}
              />

              <Switch
                label={t("allowStitch")}
                size="md"
                disabled={creatorInfo?.stitch_disabled}
                description={
                  creatorInfo?.stitch_disabled
                    ? t("disabledByCreator")
                    : undefined
                }
                {...form.getInputProps("allowStitch", { type: "checkbox" })}
              />
            </Stack>

            <Divider />

            {/* Commercial Content */}
            <Stack gap="sm">
              <Title order={5}>{t("commercialContent")}</Title>
              <Text size="sm" c="dimmed">
                {t("commercialContentDescription")}
              </Text>

              <Checkbox
                label={t("brandContentToggle")}
                description={t("brandContentDescription")}
                {...form.getInputProps("brandContentToggle", {
                  type: "checkbox",
                })}
              />

              <Checkbox
                label={t("brandOrganicToggle")}
                description={t("brandOrganicDescription")}
                {...form.getInputProps("brandOrganicToggle", {
                  type: "checkbox",
                })}
              />
            </Stack>

            <Divider />

            {/* Music Usage Confirmation */}
            <Checkbox
              label={t("musicConfirmation")}
              size="md"
              {...form.getInputProps("musicConfirmation", { type: "checkbox" })}
            />

            {/* Action Buttons */}
            <Group grow>
              <Button
                component={Link}
                href="/my-clips"
                variant="light"
                color="gray"
                size="lg"
                leftSection={<IconArrowLeft size={18} />}
              >
                {t("cancel")}
              </Button>

              <Button
                type="submit"
                loading={loading}
                leftSection={<IconBrandTiktok size={20} />}
                size="lg"
                disabled={
                  !form.values.musicConfirmation || !form.values.privacyLevel
                }
              >
                {t("publishButton")}
              </Button>
            </Group>
          </Stack>
        </Grid.Col>
        <Grid.Col span={{ base: 12, md: 4 }}>
          <Card withBorder radius="md">
            <AspectRatio ratio={9 / 16}>
              <video
                ref={videoRef}
                src={videoUrl}
                controls
                playsInline
                style={{
                  width: "100%",
                  height: "100%",
                  objectFit: "cover",
                  background: "#000",
                }}
              />
            </AspectRatio>
          </Card>
        </Grid.Col>
      </Grid>
    </form>
  );
}
