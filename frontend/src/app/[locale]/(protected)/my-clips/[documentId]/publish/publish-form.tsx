"use client";

import { Clip } from "@/lib/types/strapi-autogenerated";
import {
  Alert,
  Anchor,
  AspectRatio,
  Avatar,
  Button,
  Card,
  Checkbox,
  Divider,
  Grid,
  Group,
  Loader,
  Select,
  Stack,
  Switch,
  Text,
  TextInput,
  Title,
  Tooltip,
} from "@mantine/core";
import { useForm } from "@mantine/form";
import { notifications } from "@mantine/notifications";
import {
  IconAlertCircle,
  IconArrowLeft,
  IconInfoCircle,
  IconLock,
} from "@tabler/icons-react";
import { useTranslations } from "next-intl";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useEffect, useRef, useState } from "react";
import {
  CreatorInfo,
  getCreatorInfo,
  shareToTikTok,
} from "../../actions/share-tiktok";

interface PublishFormProps {
  clip: Clip;
  videoUrl: string;
}

export function PublishForm({ clip, videoUrl }: PublishFormProps) {
  const t = useTranslations("protected.myClips.publishPage");
  const router = useRouter();
  const videoRef = useRef<HTMLVideoElement>(null);
  const [loading, setLoading] = useState(false);
  const [creatorInfo, setCreatorInfo] = useState<CreatorInfo | null>(null);
  const [loadingCreator, setLoadingCreator] = useState(true);
  const [creatorError, setCreatorError] = useState<string | null>(null);

  const form = useForm({
    initialValues: {
      description: (clip.title || "").substring(0, 150),
      privacyLevel: "",
      allowComments: false,
      allowDuet: false,
      allowStitch: false,
      commercialContentEnabled: false,
      brandContentToggle: false,
      brandOrganicToggle: false,
    },
    validate: {
      privacyLevel: (value) =>
        !value ? t("validation.privacyRequired") : null,
    },
  });

  // Check if branded content is selected but privacy is set to private
  const isBrandedContentPrivacyConflict =
    form.values.brandOrganicToggle && form.values.privacyLevel === "SELF_ONLY";

  // Check if commercial content is enabled but no option is selected
  const isCommercialContentIncomplete =
    form.values.commercialContentEnabled &&
    !form.values.brandContentToggle &&
    !form.values.brandOrganicToggle;

  // Determine if publish button should be disabled
  const isPublishDisabled =
    !form.values.privacyLevel ||
    isCommercialContentIncomplete ||
    isBrandedContentPrivacyConflict;

  // Get tooltip message for disabled publish button
  const getPublishTooltip = () => {
    if (isCommercialContentIncomplete) {
      return t("commercialContentRequired");
    }
    if (isBrandedContentPrivacyConflict) {
      return t("brandedContentPrivacyWarning");
    }
    return null;
  };

  // Fetch creator info on mount
  useEffect(() => {
    getCreatorInfo().then((result) => {
      setLoadingCreator(false);
      if (result.success && result.data) {
        setCreatorInfo(result.data);
      } else {
        setCreatorError(result.error || "Failed to load creator info");
      }
    });
  }, []);

  const handleSubmit = async (values: typeof form.values) => {
    if (!clip.documentId) return;

    setLoading(true);
    const result = await shareToTikTok({
      clipDocumentId: clip.documentId,
      title: values.description,
      privacyLevel: values.privacyLevel,
      allowComments: values.allowComments,
      allowDuet: values.allowDuet,
      allowStitch: values.allowStitch,
      brandContentToggle: values.brandContentToggle,
      brandOrganicToggle: values.brandOrganicToggle,
    });
    setLoading(false);

    if (result.success) {
      notifications.show({
        title: t("success"),
        message: t("successMessage"),
        color: "green",
      });
      router.push("/my-clips");
    } else {
      notifications.show({
        title: t("error"),
        message: result.error,
        color: "red",
      });
    }
  };

  // Build privacy options from creator info
  const privacyOptions =
    creatorInfo?.privacy_level_options.map((level) => ({
      value: level,
      label: t(`privacy.${level}`),
    })) || [];

  if (loadingCreator) {
    return (
      <Stack align="center" py="xl">
        <Loader size="lg" />
        <Text c="dimmed">{t("loadingCreator")}</Text>
      </Stack>
    );
  }

  if (creatorError) {
    return (
      <Stack gap="md">
        <Alert icon={<IconAlertCircle size={16} />} color="red">
          {creatorError}
        </Alert>
        <Button
          component={Link}
          href="/my-clips"
          variant="light"
          leftSection={<IconArrowLeft size={16} />}
        >
          {t("backToClips")}
        </Button>
      </Stack>
    );
  }

  return (
    <form onSubmit={form.onSubmit(handleSubmit)}>
      <Grid gutter="xl">
        {/* Right side - Form */}
        <Grid.Col span={{ base: 12, md: 8 }}>
          <Stack gap="lg">
            {/* Creator Info - Publishing to this account */}
            {creatorInfo && (
              <Card withBorder radius="md" p="md">
                <Group gap="sm">
                  <Avatar
                    src={creatorInfo.creator_avatar_url}
                    size="lg"
                    radius="xl"
                  />
                  <Stack gap={0}>
                    <Text size="lg" fw={600}>
                      {creatorInfo.creator_nickname}
                    </Text>
                    <Text size="md" c="dimmed">
                      @{creatorInfo.creator_username}
                    </Text>
                  </Stack>
                </Group>
              </Card>
            )}

            {/* Description */}
            <TextInput
              label={t("descriptionLabel")}
              placeholder={t("descriptionPlaceholder")}
              maxLength={150}
              size="lg"
              rightSection={
                <Text size="sm" c="dimmed" pr="xs">
                  {form.values.description.length}/150
                </Text>
              }
              rightSectionWidth={60}
              {...form.getInputProps("description")}
            />

            <Divider />

            {/* Privacy Level */}
            <Select
              label={t("privacyLabel")}
              placeholder={t("privacyPlaceholder")}
              data={privacyOptions}
              size="lg"
              leftSection={<IconLock size={16} />}
              withAsterisk
              {...form.getInputProps("privacyLevel")}
              onChange={(value) => {
                form.setFieldValue("privacyLevel", value || "");
                // Uncheck branded content if privacy is set to private
                if (value === "SELF_ONLY") {
                  form.setFieldValue("brandOrganicToggle", false);
                }
              }}
            />

            <Divider />

            {/* Interaction Settings */}
            <Stack gap="sm">
              <Title order={4}>{t("interactionSettings")}</Title>

              <Checkbox
                label={t("allowComments")}
                size="md"
                disabled={creatorInfo?.comment_disabled}
                description={
                  creatorInfo?.comment_disabled
                    ? t("disabledByCreator")
                    : undefined
                }
                {...form.getInputProps("allowComments", { type: "checkbox" })}
              />

              <Checkbox
                label={t("allowDuet")}
                size="md"
                disabled={creatorInfo?.duet_disabled}
                description={
                  creatorInfo?.duet_disabled
                    ? t("disabledByCreator")
                    : undefined
                }
                {...form.getInputProps("allowDuet", { type: "checkbox" })}
              />

              <Checkbox
                label={t("allowStitch")}
                size="md"
                disabled={creatorInfo?.stitch_disabled}
                description={
                  creatorInfo?.stitch_disabled
                    ? t("disabledByCreator")
                    : undefined
                }
                {...form.getInputProps("allowStitch", { type: "checkbox" })}
              />
            </Stack>

            <Divider />

            {/* Commercial Content */}
            <Stack gap="sm">
              <Title order={5}>{t("commercialContent")}</Title>
              <Text size="md" c="dimmed">
                {t("commercialContentDescription")}
              </Text>

              <Switch
                label={t("commercialContentToggle")}
                size="md"
                {...form.getInputProps("commercialContentEnabled", {
                  type: "checkbox",
                })}
                onChange={(e) => {
                  form.setFieldValue(
                    "commercialContentEnabled",
                    e.currentTarget.checked,
                  );
                  // Reset sub-options when turning off
                  if (!e.currentTarget.checked) {
                    form.setFieldValue("brandContentToggle", false);
                    form.setFieldValue("brandOrganicToggle", false);
                  }
                }}
              />

              {form.values.commercialContentEnabled && (
                <Stack gap="xs" ml="md">
                  <Checkbox
                    label={t("brandContentToggle")}
                    size="md"
                    description={t("brandContentDescription")}
                    {...form.getInputProps("brandContentToggle", {
                      type: "checkbox",
                    })}
                  />

                  <Checkbox
                    label={t("brandOrganicToggle")}
                    size="md"
                    description={t("brandOrganicDescription")}
                    disabled={form.values.privacyLevel === "SELF_ONLY"}
                    {...form.getInputProps("brandOrganicToggle", {
                      type: "checkbox",
                    })}
                  />
                  {form.values.privacyLevel === "SELF_ONLY" && (
                    <Text size="sm" c="orange">
                      {t("brandedContentPrivacyWarning")}
                    </Text>
                  )}
                  {(form.values.brandContentToggle ||
                    form.values.brandOrganicToggle) && (
                    <Alert
                      variant="light"
                      color="blue"
                      py="xs"
                      mt="xs"
                      icon={<IconInfoCircle />}
                    >
                      <Text size="md">
                        {form.values.brandOrganicToggle
                          ? t("paidPartnershipLabel")
                          : t("promotionalContentLabel")}
                      </Text>
                      <Text size="md" mt={4}>
                        {t("cannotChangeWarning")}
                      </Text>
                    </Alert>
                  )}
                </Stack>
              )}
            </Stack>

            <Divider />

            {/* Music Usage Confirmation Declaration */}
            <Text size="md" c="dimmed" ta="center">
              {form.values.brandOrganicToggle
                ? t("brandedContentConfirmationPrefix")
                : t("musicConfirmationPrefix")}{" "}
              {form.values.brandOrganicToggle && (
                <>
                  <Anchor
                    href="https://www.tiktok.com/legal/page/global/bc-policy/en"
                    target="_blank"
                  >
                    {t("brandedContentPolicyLink")}
                  </Anchor>{" "}
                  {t("andText")}{" "}
                </>
              )}
              <Anchor
                href="https://www.tiktok.com/legal/page/global/music-usage-confirmation/en"
                target="_blank"
              >
                {t("musicConfirmationLink")}
              </Anchor>
            </Text>

            {/* Action Buttons */}
            <Group grow>
              <Button
                component={Link}
                href="/my-clips"
                variant="light"
                color="gray"
                size="lg"
                leftSection={<IconArrowLeft size={18} />}
              >
                {t("cancel")}
              </Button>

              <Tooltip
                label={getPublishTooltip()}
                disabled={!getPublishTooltip()}
                withArrow
              >
                <span style={{ flex: 1 }}>
                  <Button
                    type="submit"
                    loading={loading}
                    size="lg"
                    disabled={isPublishDisabled}
                    fullWidth
                  >
                    {t("uploadButton")}
                  </Button>
                </span>
              </Tooltip>
            </Group>
          </Stack>
        </Grid.Col>
        <Grid.Col span={{ base: 12, md: 4 }}>
          <Card withBorder radius="md">
            <AspectRatio ratio={9 / 16}>
              <video
                ref={videoRef}
                src={videoUrl}
                controls
                playsInline
                style={{
                  width: "100%",
                  height: "100%",
                  objectFit: "cover",
                  background: "#000",
                }}
              />
            </AspectRatio>
          </Card>
        </Grid.Col>
      </Grid>
    </form>
  );
}
