"use client";

import { generateAvatarUrl } from "@/app/lib/avatar-url";
import { safeRelativeTime } from "@/app/lib/safe-relative-time";
import { useIsRole } from "@/app/providers/ability-provider";
import { AiRequest } from "@/lib/types/strapi-autogenerated";
import {
  Avatar,
  Badge,
  Box,
  Button,
  Card,
  Center,
  Group,
  Stack,
  Text,
} from "@mantine/core";
import { IconEye, IconTrash } from "@tabler/icons-react";
import { useFormatter, useNow, useTranslations } from "next-intl";
import Image from "next/image";
import Link from "next/link";
import { MiniPlayer } from "../../components/video/mini-player";
import { deriveRequestState } from "../utils/derive-state";

interface Props {
  aiRequest: AiRequest;
}

export function AiRequestCard({ aiRequest }: Props) {
  const format = useFormatter();
  const now = useNow({ updateInterval: 1000 * 30 });
  const t = useTranslations("protected.aiStudio");
  const isAdmin = useIsRole("admin");

  const stateColors: Record<string, string> = {
    pending: "gray",
    processing: "yellow",
    completed: "green",
    failed: "red",
  };

  const follower = aiRequest.follower;
  const recording = aiRequest.recording;
  const isRecordingDeleted = !recording;

  const derivedState = deriveRequestState(aiRequest, isAdmin);

  return (
    <Card radius="md" withBorder padding="sm">
      <Stack gap="sm">
        {/* Header */}
        <Group justify="space-between" wrap="nowrap">
          <Group gap="sm" wrap="nowrap" style={{ flex: 1, minWidth: 0 }}>
            <Avatar size={36} radius="xl">
              {follower?.avatar?.url && (
                <Image
                  src={generateAvatarUrl(follower.avatar.url)}
                  alt={follower?.username || "Avatar"}
                  width={36}
                  height={36}
                />
              )}
            </Avatar>
            <Stack gap={0} style={{ flex: 1, minWidth: 0 }}>
              <Text fw={500} size="sm" truncate>
                {follower?.username || t("unknownCreator")}
              </Text>
              <Text size="xs" c="dimmed" suppressHydrationWarning>
                {safeRelativeTime(format, aiRequest.createdAt, { now })}
              </Text>
            </Stack>
          </Group>
          <Group gap={4}>
            {aiRequest.generateClips && (
              <Badge variant="light" size="xs">
                {t("options.clips")}
              </Badge>
            )}
            {aiRequest.generateMemes && (
              <Badge variant="light" size="xs">
                {t("options.memes")}
              </Badge>
            )}
          </Group>
        </Group>

        {/* Video Preview */}
        <Box pos="relative" style={{ aspectRatio: "16/9" }}>
          {isRecordingDeleted ? (
            <Center
              h="100%"
              bg="dark.6"
              style={{ borderRadius: "var(--mantine-radius-md)" }}
            >
              <Stack align="center" gap="xs">
                <IconTrash size={32} color="var(--mantine-color-gray-6)" />
                <Text size="sm" c="dimmed">
                  {t("recordingDeleted.badge")}
                </Text>
              </Stack>
            </Center>
          ) : (
            <MiniPlayer documentId={recording?.documentId!} />
          )}
        </Box>

        {/* Status */}
        <Group justify="space-between">
          <Badge
            color={stateColors[derivedState]}
            size="lg"
            variant="light"
            radius="sm"
          >
            {t(`state.${derivedState}`)}
          </Badge>
          <Button
            component={Link}
            href={`/ai-studio/${aiRequest.documentId}/view`}
            size="xs"
            variant="light"
            leftSection={<IconEye size={14} />}
          >
            {t("viewDetails")}
          </Button>
        </Group>
      </Stack>
    </Card>
  );
}
