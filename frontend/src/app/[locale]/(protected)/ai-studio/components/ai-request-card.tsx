"use client";

import { generateAvatarUrl } from "@/app/lib/avatar-url";
import { safeRelativeTime } from "@/app/lib/safe-relative-time";
import { AiRequest } from "@/lib/types/strapi-autogenerated";
import {
  Avatar,
  Badge,
  Box,
  Card,
  Center,
  Group,
  Stack,
  Text,
} from "@mantine/core";
import { IconSparkles, IconTrash } from "@tabler/icons-react";
import { useFormatter, useNow, useTranslations } from "next-intl";
import Image from "next/image";
import Link from "next/link";
import { MiniPlayer } from "../../components/video/mini-player";

interface Props {
  aiRequest: AiRequest;
}

export function AiRequestCard({ aiRequest }: Props) {
  const format = useFormatter();
  const now = useNow({ updateInterval: 1000 * 30 });
  const t = useTranslations("protected.aiStudio");

  const stateColors: Record<string, string> = {
    pending: "yellow",
    processing: "blue",
    completed: "green",
    failed: "red",
  };

  const follower = aiRequest.follower;
  const recording = aiRequest.recording;
  const isRecordingDeleted = !recording;

  return (
    <Card padding="md" radius="md" withBorder>
      {/* Video Preview */}
      <Box pos="relative" style={{ aspectRatio: "16/9" }} mb="sm">
        {isRecordingDeleted ? (
          <Center
            h="100%"
            bg="dark.6"
            style={{ borderRadius: "var(--mantine-radius-md)" }}
          >
            <Stack align="center" gap="xs">
              <IconTrash size={32} color="var(--mantine-color-gray-6)" />
              <Text size="sm" c="dimmed">
                {t("recordingDeleted.badge")}
              </Text>
            </Stack>
          </Center>
        ) : (
          <MiniPlayer documentId={recording?.documentId!} />
        )}
        <Badge
          color={stateColors[aiRequest.state || "pending"]}
          variant="filled"
          size="sm"
          pos="absolute"
          top={8}
          right={8}
          style={{ zIndex: 10 }}
        >
          {t(`state.${aiRequest.state || "pending"}`)}
        </Badge>
      </Box>

      {/* Info */}
      <Link
        href={`/ai-studio/${aiRequest.documentId}`}
        style={{ textDecoration: "none", color: "inherit" }}
      >
        <Group justify="space-between" wrap="nowrap">
          <Group gap="sm" wrap="nowrap">
            <Avatar size={40} radius="xl">
              {follower?.avatar?.url && (
                <Image
                  src={generateAvatarUrl(follower.avatar.url)}
                  alt={follower.username || "Avatar"}
                  width={40}
                  height={40}
                />
              )}
            </Avatar>
            <Stack gap={2}>
              <Group gap="xs">
                <IconSparkles size={14} color="var(--mantine-color-violet-6)" />
                <Text fw={500} size="sm" truncate maw={120}>
                  {follower?.username || t("unknownCreator")}
                </Text>
              </Group>
              <Text size="xs" c="dimmed" suppressHydrationWarning>
                {t("createdAgo", {
                  time: safeRelativeTime(format, aiRequest.createdAt, { now }),
                })}
              </Text>
            </Stack>
          </Group>
          <Group gap="xs" mt="xs">
            {aiRequest.generateClips && (
              <Badge variant="outline" size="xs">
                {t("options.clips")}
              </Badge>
            )}
            {aiRequest.generateMemes && (
              <Badge variant="outline" size="xs">
                {t("options.memes")}
              </Badge>
            )}
            {aiRequest.generateProfile && (
              <Badge variant="outline" size="xs">
                {t("options.profile")}
              </Badge>
            )}
          </Group>
        </Group>
      </Link>
    </Card>
  );
}
