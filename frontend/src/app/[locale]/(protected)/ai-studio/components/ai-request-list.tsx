"use client";

import { AiRequest } from "@/lib/types/strapi-autogenerated";
import { SegmentedControl, SimpleGrid, Stack } from "@mantine/core";
import { useTranslations } from "next-intl";
import { useState } from "react";
import { AiRequestCard } from "./ai-request-card";
import { useIsRole } from "@/app/providers/ability-provider";

interface Props {
  aiRequests: AiRequest[];
}

// Derive state from tasks
function deriveState(aiRequest: AiRequest, isAdmin: boolean): string {
  const expectedTotal =
    2 +
    (aiRequest.generateClips ? 2 : 0) +
    (aiRequest.generateMemes ? 2 : 0) +
    (aiRequest.generateProfile && isAdmin ? 2 : 0);

  const tasks = aiRequest.ai_tasks || [];
  const visibleTasks = isAdmin
    ? tasks
    : tasks.filter((t) => !t.type?.startsWith("profile::"));

  const completedTasks = visibleTasks.filter(
    (t) => t.state === "completed",
  ).length;
  const failedTasks = visibleTasks.filter((t) => t.state === "failed").length;
  const processingTasks = visibleTasks.filter(
    (t) => t.state === "processing",
  ).length;

  return failedTasks > 0
    ? "failed"
    : completedTasks >= expectedTotal
      ? "completed"
      : processingTasks > 0 || completedTasks > 0
        ? "processing"
        : "pending";
}

export function AiRequestList({ aiRequests }: Props) {
  const t = useTranslations("protected.aiStudio");
  const isAdmin = useIsRole("admin");
  const [filter, setFilter] = useState("all");

  const filteredRequests = aiRequests.filter((request) => {
    if (filter === "all") return true;
    const state = deriveState(request, isAdmin);
    if (filter === "completed") return state === "completed" || state === "failed";
    return state === filter;
  });

  return (
    <Stack gap="md">
      <SegmentedControl
        value={filter}
        onChange={setFilter}
        data={[
          { label: t("filters.all"), value: "all" },
          { label: t("filters.pending"), value: "pending" },
          { label: t("filters.processing"), value: "processing" },
          { label: t("filters.completed"), value: "completed" },
        ]}
      />
      <SimpleGrid cols={{ base: 1, md: 2 }}>
        {filteredRequests.map((request) => (
          <AiRequestCard key={request.documentId} aiRequest={request} />
        ))}
      </SimpleGrid>
    </Stack>
  );
}
