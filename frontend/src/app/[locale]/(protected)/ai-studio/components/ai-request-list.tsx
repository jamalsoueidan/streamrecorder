"use client";

import { useIsRole } from "@/app/providers/ability-provider";
import { AiRequest } from "@/lib/types/strapi-autogenerated";
import {
  Center,
  Pagination,
  SegmentedControl,
  SimpleGrid,
  Stack,
} from "@mantine/core";
import { useTranslations } from "next-intl";
import { useRouter, useSearchParams } from "next/navigation";
import { useState } from "react";
import { deriveRequestState } from "../utils/derive-state";
import { AiRequestCard } from "./ai-request-card";

interface Props {
  aiRequests: AiRequest[];
  currentPage: number;
  totalPages: number;
}

export function AiRequestList({
  aiRequests,
  currentPage,
  totalPages,
}: Props) {
  const t = useTranslations("protected.aiStudio");
  const isAdmin = useIsRole("admin");
  const router = useRouter();
  const searchParams = useSearchParams();
  const [filter, setFilter] = useState("all");

  const filteredRequests = aiRequests.filter((request) => {
    if (filter === "all") return true;
    const state = deriveRequestState(request, isAdmin);
    if (filter === "completed")
      return state === "completed" || state === "failed";
    return state === filter;
  });

  const handlePageChange = (page: number) => {
    const params = new URLSearchParams(searchParams.toString());
    params.set("page", page.toString());
    router.push(`?${params.toString()}`);
  };

  return (
    <Stack gap="md">
      <SegmentedControl
        value={filter}
        onChange={setFilter}
        data={[
          { label: t("filters.all"), value: "all" },
          { label: t("filters.pending"), value: "pending" },
          { label: t("filters.processing"), value: "processing" },
          { label: t("filters.completed"), value: "completed" },
        ]}
      />
      <SimpleGrid cols={{ base: 1, md: 2 }}>
        {filteredRequests.map((request) => (
          <AiRequestCard key={request.documentId} aiRequest={request} />
        ))}
      </SimpleGrid>
      {totalPages > 1 && (
        <Center>
          <Pagination
            value={currentPage}
            onChange={handlePageChange}
            total={totalPages}
          />
        </Center>
      )}
    </Stack>
  );
}
