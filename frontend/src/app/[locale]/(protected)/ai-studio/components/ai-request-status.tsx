"use client";

import { AiRequest } from "@/lib/types/strapi-autogenerated";
import {
  Badge,
  Card,
  Group,
  Progress,
  Stack,
  Text,
  Title,
} from "@mantine/core";
import {
  IconCheck,
  IconLoader,
  IconClock,
  IconX,
} from "@tabler/icons-react";
import { useTranslations } from "next-intl";

interface Props {
  aiRequest: AiRequest;
}

export function AiRequestStatus({ aiRequest }: Props) {
  const t = useTranslations("protected.aiStudio.status");

  const tasks = aiRequest.ai_tasks || [];
  const completedTasks = tasks.filter((t) => t.state === "completed").length;
  const totalTasks = tasks.length;
  const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

  const stateColors: Record<string, string> = {
    pending: "yellow",
    processing: "blue",
    completed: "green",
    failed: "red",
  };

  const stateIcons: Record<string, React.ReactNode> = {
    pending: <IconClock size={16} />,
    processing: <IconLoader size={16} className="animate-spin" />,
    completed: <IconCheck size={16} />,
    failed: <IconX size={16} />,
  };

  return (
    <Stack gap="lg">
      <Stack gap={4}>
        <Group gap="sm">
          <Title order={2}>{t("title")}</Title>
          <Badge
            color={stateColors[aiRequest.state || "pending"]}
            variant="light"
            size="lg"
          >
            {t(`state.${aiRequest.state || "pending"}`)}
          </Badge>
        </Group>
        <Text c="dimmed">{t("description")}</Text>
      </Stack>

      {totalTasks > 0 && (
        <Card withBorder padding="md">
          <Stack gap="sm">
            <Group justify="space-between">
              <Text fw={500}>{t("progress")}</Text>
              <Text size="sm" c="dimmed">
                {completedTasks} / {totalTasks}
              </Text>
            </Group>
            <Progress value={progress} color="violet" size="lg" animated={aiRequest.state === "processing"} />
          </Stack>
        </Card>
      )}

      {tasks.length > 0 && (
        <Stack gap="sm">
          <Text fw={500}>{t("tasks")}</Text>
          {tasks.map((task) => (
            <Card key={task.documentId} withBorder padding="sm">
              <Group justify="space-between">
                <Group gap="xs">
                  {stateIcons[task.state || "pending"]}
                  <Text size="sm" tt="capitalize">
                    {task.type}
                  </Text>
                </Group>
                <Badge
                  color={stateColors[task.state || "pending"]}
                  variant="light"
                  size="sm"
                >
                  {t(`state.${task.state || "pending"}`)}
                </Badge>
              </Group>
            </Card>
          ))}
        </Stack>
      )}

      <Group gap="xs" mt="md">
        {aiRequest.generateClips && (
          <Badge variant="outline">{t("options.clips")}</Badge>
        )}
        {aiRequest.generateMemes && (
          <Badge variant="outline">{t("options.memes")}</Badge>
        )}
        {aiRequest.generateProfile && (
          <Badge variant="outline">{t("options.profile")}</Badge>
        )}
      </Group>
    </Stack>
  );
}
