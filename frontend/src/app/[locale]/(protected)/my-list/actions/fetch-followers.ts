"use server";

import api from "@/lib/api";
import { ScopeEnum } from "@/lib/types/strapi-autogenerated";
import { deepMerge } from "@mantine/core";
import { buildCreatorsFilters, CreatorFilters } from "../lib/search-params";

const defaultOptions = {
  "pagination[pageSize]": 10,
  scope: ScopeEnum.Following,
  populate: {
    avatar: { fields: ["url"] },
  },
};

export async function fetchFollowers(filters: CreatorFilters, page: number) {
  const response = await api.follower.browseFollowers(
    deepMerge(defaultOptions, {
      filters: buildCreatorsFilters(filters),
      sort: filters.sort,
      hasRecordings: filters.hasRecordings,
      "pagination[page]": page,
    }),
  );

  return {
    data: response.data?.data || [],
    meta: response.data?.meta,
  };
}

export async function getRecordings(
  username: string,
  type: string,
  page: number = 1,
  pageSize: number = 8,
) {
  const response = await api.recording.getRecordings({
    filters: {
      follower: {
        username: { $eq: username.replace(/^(%40|@)/, "") },
        type: { $eq: type },
      },
      sources: {
        state: {
          $in: ["done", "recording"],
        },
      },
    },
    populate: {
      sources: {
        fields: ["*"],
        filters: {
          state: {
            $ne: "failed",
          },
        },
      },
      follower: {
        populate: {
          avatar: { fields: ["url"] },
        },
      },
    },
    sort: "createdAt:desc",
    "pagination[page]": page,
    "pagination[pageSize]": pageSize,
  });

  return {
    data: response.data?.data || [],
    meta: response.data?.meta,
  };
}
