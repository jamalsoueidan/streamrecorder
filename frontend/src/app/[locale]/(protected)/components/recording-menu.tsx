"use client";

import { deleteRecording, toggleHidden } from "@/app/actions/recording";
import { useUser } from "@/app/providers/user-provider";
import { Recording } from "@/lib/types/strapi-autogenerated";
import { ActionIcon, Menu, Text } from "@mantine/core";
import { modals } from "@mantine/modals";
import { IconDots, IconEye, IconEyeOff, IconTrash } from "@tabler/icons-react";
import { useQueryClient } from "@tanstack/react-query";
import { useTranslations } from "next-intl";

interface RecordingMenuProps {
  recording: Recording;
  username: string;
  type: string;
}

export function RecordingMenu({
  recording,
  username,
  type,
}: RecordingMenuProps) {
  const user = useUser();
  const t = useTranslations("protected.common.recordings");
  const queryClient = useQueryClient();

  const isOwner = user?.id && recording.follower?.owner?.id === user.id;

  const handleDelete = () => {
    if (!recording.documentId) return;
    modals.openConfirmModal({
      title: t("deleteConfirm.title"),
      children: <Text size="sm">{t("deleteConfirm.message")}</Text>,
      labels: { confirm: t("deleteConfirm.confirm"), cancel: t("deleteConfirm.cancel") },
      confirmProps: { color: "red" },
      onConfirm: async () => {
        const result = await deleteRecording(recording.documentId!);
        if (result.success) {
          queryClient.invalidateQueries({
            queryKey: ["recordings", username, type],
          });
        }
      },
    });
  };

  const handleToggleHidden = async () => {
    if (!recording.documentId) return;
    const result = await toggleHidden(recording.documentId, !!recording.hidden);
    if (result.success) {
      queryClient.invalidateQueries({
        queryKey: ["recordings", username, type],
      });
    }
  };

  if (!isOwner) {
    return null;
  }

  return (
    <Menu shadow="md">
      <Menu.Target>
        <ActionIcon
          variant="filled"
          color="dark"
          size="md"
          onClick={(e) => e.preventDefault()}
        >
          <IconDots />
        </ActionIcon>
      </Menu.Target>
      <Menu.Dropdown>
        <Menu.Item
          leftSection={
            recording.hidden ? <IconEye size={14} /> : <IconEyeOff size={14} />
          }
          onClick={handleToggleHidden}
        >
          {recording.hidden ? t("show") : t("hide")}
        </Menu.Item>
        <Menu.Item
          color="red"
          leftSection={<IconTrash size={14} />}
          onClick={handleDelete}
        >
          {t("delete")}
        </Menu.Item>
      </Menu.Dropdown>
    </Menu>
  );
}
