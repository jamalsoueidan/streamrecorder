// sprite-preview.tsx
"use client";

import { Source } from "@/lib/types/strapi-autogenerated";
import { useEffect, useMemo, useState } from "react";

const FRAME_INTERVAL_MS = 300;

interface SpritePreviewProps {
  baseUrl: string;
  sources: Source[];
}

interface FrameInfo {
  sourceId: string;
  cols: number;
  frameIndex: number;
}

export function SpritePreview({ baseUrl, sources }: SpritePreviewProps) {
  const [frame, setFrame] = useState(0);
  const [loaded, setLoaded] = useState(false);

  const allFrames = useMemo(() => {
    const frames: FrameInfo[] = [];
    sources.sort((a, b) =>
      (a.createdAt || "").localeCompare(b.createdAt || ""),
    );

    for (const source of sources) {
      const cols = source.thumbnailCols || 5;
      const total = cols * cols;

      for (let i = 0; i < total; i++) {
        frames.push({
          sourceId: source.documentId!,
          cols,
          frameIndex: i,
        });
      }
    }

    return frames;
  }, [sources]);

  const current = allFrames[frame];

  // Preload first sprite
  useEffect(() => {
    if (!current) return;

    const img = new Image();
    img.onload = () => setLoaded(true);
    img.src = `${baseUrl}?sourceId=${current.sourceId}`;
  }, [baseUrl, current]);

  useEffect(() => {
    if (!loaded || allFrames.length === 0) return;

    const timer = setInterval(() => {
      setFrame((f) => (f + 1) % allFrames.length);
    }, FRAME_INTERVAL_MS);

    return () => clearInterval(timer);
  }, [loaded, allFrames.length]);

  if (!loaded || !current) return null;

  const col = current.frameIndex % current.cols;
  const row = Math.floor(current.frameIndex / current.cols);

  return (
    <div
      style={{
        position: "absolute",
        inset: 0,
        backgroundImage: `url(${baseUrl}?sourceId=${current.sourceId})`,
        backgroundSize: `auto ${current.cols * 100}%`,
        backgroundPosition: `${col * (100 / (current.cols - 1))}% ${row * (100 / (current.cols - 1))}%`,
        backgroundRepeat: "no-repeat",
        borderRadius: "var(--mantine-radius-md)",
      }}
    />
  );
}
