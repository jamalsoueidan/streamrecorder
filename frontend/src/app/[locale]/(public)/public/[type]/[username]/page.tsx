import { ActionIcon, SimpleGrid, Stack, Text, Title } from "@mantine/core";
import { IconVideo } from "@tabler/icons-react";

import dayjs from "@/app/lib/dayjs";
import { fetchProfileRecordings, getFollower } from "./actions/actions";

import { getSocialUrl } from "@/app/components/open-social";
import { generateAvatarUrl } from "@/app/lib/avatar-url";
import { generateProfileUrl } from "@/app/lib/profile-url";
import { FollowerTypeEnum } from "@/lib/types/strapi-autogenerated";
import { Metadata } from "next";
import { ImageVideoPreview } from "./components/image-video-preview";

interface PageProps {
  params: Promise<{
    username: string;
    type: string;
  }>;
}

export async function generateMetadata({
  params,
}: {
  params: Promise<{ username: string; type: string }>;
}): Promise<Metadata> {
  const { type, username } = await params;
  const follower = await getFollower({ username, type });

  if (!follower) {
    return {
      title: "Streamer Not Found",
      description: "This creator profile could not be found.",
    };
  }

  const platformName = type.charAt(0).toUpperCase() + type.slice(1);
  const title = `${follower.nickname} (@${follower.username}) VODs & Recordings`;
  const description =
    follower.tagline ||
    `Watch ${follower.nickname}'s recorded ${platformName} streams anytime. Never miss a live stream – we record automatically so you can watch later or download for free.`;

  return {
    title,
    description,
    keywords: [
      `${follower.nickname} vods`,
      `${follower.nickname} streams`,
      `${follower.nickname} recordings`,
      `${follower.nickname} ${platformName}`,
      `watch ${follower.nickname}`,
      `${follower.nickname} live stream`,
      "live stream recorder",
      "stream recording",
      `${platformName.toLowerCase()} vod downloader`,
      `${platformName.toLowerCase()} stream recorder`,
    ],
    openGraph: {
      title: `${follower.nickname} – Watch Recorded Streams | Live Stream Recorder`,
      description,
      type: "profile",
      siteName: "Live Stream Recorder",
      images: [
        `https://www.livestreamrecorder.com/api/og/${generateProfileUrl(
          follower,
          false
        )}`,
      ],
    },
    twitter: {
      card: "summary_large_image",
      title: `${follower.nickname} – Recorded ${platformName} Streams`,
      description,
      images: [
        `https://www.livestreamrecorder.com/api/og/${generateProfileUrl(
          follower,
          false
        )}`,
      ],
    },
    alternates: {
      canonical: generateProfileUrl(follower, true),
    },
  };
}

export default async function Page({ params }: PageProps) {
  const { type, username } = await params;

  const follower = await getFollower({ username, type });

  const data = await fetchProfileRecordings(type, username);

  const recordings = data?.data ?? [];
  const hasRecordings = recordings.length > 0;

  const jsonLd = {
    "@context": "https://schema.org",
    "@type": "Person",
    name: follower.nickname || follower.username,
    alternateName: `@${follower.username}`,
    description: follower.tagline || follower.description,
    image: generateAvatarUrl(follower.avatar?.url, true),
    url: generateProfileUrl(follower, true),
    nationality: follower.country,
    sameAs: [getSocialUrl(follower)],
    video: recordings.slice(0, 5).map((video) => {
      const duration =
        video.sources?.reduce(
          (acc, source) => acc + (source.duration || 0),
          0
        ) || 0;

      return {
        "@type": "VideoObject",
        name: `${follower?.nickname || follower?.username}'s Stream - ${dayjs(
          video.createdAt
        ).format("MMM D, YYYY")}`,
        thumbnailUrl: video.sources?.length
          ? "https://www.livestreamrecorder.com/media" +
            video.sources[video.sources.length - 1].path +
            "screenshot.jpg"
          : null,
        description: `Recorded live stream from ${follower.nickname} on ${dayjs(
          video.createdAt
        ).format("MMM D, YYYY")}`,
        uploadDate: video.createdAt,
        duration: `PT${Math.floor(duration / 60)}M${Math.round(
          duration % 60
        )}S`,
        contentUrl: `${generateProfileUrl(follower, true)}/video/${
          video.documentId
        }`,
      };
    }),
  };

  return (
    <>
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
      />
      {!hasRecordings ? (
        <EmptyState />
      ) : (
        <Stack gap="xl">
          <Stack gap="md">
            <SimpleGrid cols={{ base: 1, sm: 2 }} spacing="lg">
              {recordings?.map((rec) => (
                <Stack key={rec.documentId} gap={4}>
                  <ImageVideoPreview
                    recording={rec}
                    username={username}
                    type={type as unknown as FollowerTypeEnum}
                  />
                  <Text size="xs">
                    Recorded{" "}
                    <time dateTime={rec.createdAt}>
                      {dayjs(rec.createdAt).format("MMM D, YYYY")}
                    </time>
                  </Text>
                </Stack>
              ))}
            </SimpleGrid>
          </Stack>
        </Stack>
      )}
    </>
  );
}

function EmptyState() {
  return (
    <Stack align="center" justify="center" py={80} gap="lg">
      <ActionIcon variant="transparent" size={120} radius="xl" color="white">
        <IconVideo size={90} stroke={2} />
      </ActionIcon>
      <Stack align="center" gap={12}>
        <Title order={2} fw={600}>
          No recordings yet
        </Title>
        <Text size="xl" c="dimmed" maw={450} ta="center">
          We haven&apos;t captured any streams from this creator yet. Check back
          later!
        </Text>
      </Stack>
    </Stack>
  );
}
