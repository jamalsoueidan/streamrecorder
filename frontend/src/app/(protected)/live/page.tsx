import api from "@/lib/api";
import { ScopeEnum } from "@/lib/types/strapi-autogenerated";
import {
  ActionIcon,
  Anchor,
  Badge,
  Button,
  deepMerge,
  Divider,
  Group,
  Stack,
  Text,
  Title,
  Tooltip,
} from "@mantine/core";
import {
  IconPlayerRecordFilled,
  IconRefresh,
  IconStar,
  IconVideo,
  IconWorldSearch,
} from "@tabler/icons-react";
import LiveInfinity from "./components/live-infinity";

const defaultOptions = {
  "pagination[pageSize]": 10,
  sort: "updatedAt:desc",
  filters: {
    sources: {
      state: {
        $eq: "recording",
      },
    },
  },
  populate: {
    sources: {
      filters: {
        state: {
          $eq: "recording",
        },
      },
    },
    follower: {
      fields: ["username", "type"],
      populate: {
        avatar: {
          fields: ["url"],
        },
      },
    },
  },
};

interface PageProps {
  searchParams: Promise<{
    scope?: string;
  }>;
}

export default async function FollowingsPage({ searchParams }: PageProps) {
  const { scope = ScopeEnum.Following } = await searchParams;

  const fetchAction = async (
    options: Parameters<typeof api.recording.browseRecordings>[0]
  ) => {
    "use server";
    const response = await api.recording.browseRecordings(
      deepMerge(defaultOptions, { ...options, scope })
    );

    return {
      data: response.data?.data || [],
      meta: response.data?.meta,
    };
  };

  const { data, meta } = await fetchAction({
    "pagination[page]": 1,
  });

  return (
    <section>
      {data.length === 0 ? (
        <Stack align="center" justify="center" py={80} gap="lg">
          <ActionIcon
            variant="transparent"
            size={120}
            radius="xl"
            color="white"
          >
            <IconVideo size={90} stroke={2} />
          </ActionIcon>
          <Stack align="center" gap={12}>
            <Title order={2} fw={600}>
              No live recordings yet
            </Title>
            <Text size="xl" c="dimmed" maw={450} ta="center">
              Your followed streamers live status appears here
            </Text>
          </Stack>
          <Anchor href="/discover" underline="never">
            <Button
              size="lg"
              radius="md"
              leftSection={<IconWorldSearch size={20} />}
            >
              Discover Streamers
            </Button>
          </Anchor>
        </Stack>
      ) : (
        <Stack gap="sm">
          <Group justify="space-between" align="flex-start">
            <Stack gap={2}>
              <Group gap="xs">
                <IconPlayerRecordFilled color="red" size="32px" />
                <Title order={1} size="h3">
                  Live Now
                </Title>
                <Badge
                  size="lg"
                  color="red"
                  variant="dot"
                  styles={{
                    root: {
                      animation: "pulse 2s infinite",
                    },
                  }}
                >
                  {meta?.pagination?.total} streaming
                </Badge>
              </Group>
              <Text c="dimmed" size="sm">
                Watch live streams from your followed creators
              </Text>
            </Stack>

            <Group gap="xs">
              <Tooltip label="Refresh">
                <Anchor href="/live" underline="never">
                  <ActionIcon variant="subtle" size={50}>
                    <IconRefresh size={20} />
                  </ActionIcon>
                </Anchor>
              </Tooltip>
              <Anchor href="/creators" underline="never">
                <Button
                  variant="light"
                  leftSection={<IconStar size={18} />}
                  size="lg"
                >
                  Creators
                </Button>
              </Anchor>
            </Group>
          </Group>

          <Divider />

          <LiveInfinity
            initialData={data}
            initialPagination={meta}
            fetchAction={fetchAction}
          />
        </Stack>
      )}
    </section>
  );
}
