// lib/search-params.ts
import { getDateRange } from "@/app/lib/get-date-range";
import { SortOptions } from "@/lib/types/filtering";
import { ScopeEnum } from "@/lib/types/strapi-autogenerated";
import {
  createSearchParamsCache,
  inferParserType,
  parseAsString,
  parseAsStringEnum,
} from "nuqs/server";

export const followingDefaultOptions = {
  scope: ScopeEnum.Following,
  filters: {
    sources: {
      state: {
        $eq: ["done"],
      },
    },
  },
  populate: {
    sources: {
      fields: ["*"],
      filters: {
        state: {
          $eq: "done",
        },
      },
      populate: ["videoSmall", "videoOriginal"], // we ask for original because sometime small is null while encoding for mini-player
    },
    follower: {
      fields: ["username", "type"],
      populate: {
        avatar: {
          fields: ["url"],
        },
      },
    },
  },
};

export const discoverParsers = {
  sort: parseAsStringEnum<SortOptions>(Object.values(SortOptions)).withDefault(
    SortOptions.createdAtDesc
  ),
  scope: parseAsStringEnum<ScopeEnum>(Object.values(ScopeEnum)).withDefault(
    ScopeEnum.Following
  ),
  gender: parseAsString,
  country: parseAsString,
  language: parseAsString,
  type: parseAsString,
  search: parseAsString,
  dateRange: parseAsString,
};

export const discoverParamsCache = createSearchParamsCache(discoverParsers);

export type DiscoverFilters = inferParserType<typeof discoverParsers>;

export const buildRecordingFilters = (filters: DiscoverFilters) => ({
  ...(filters.gender && { follower: { gender: { $eq: filters.gender } } }),
  ...(filters.country && {
    follower: { countryCode: { $eq: filters.country } },
  }),
  ...(filters.language && {
    follower: { languageCode: { $eq: filters.language } },
  }),
  ...(filters.type && { follower: { type: { $eq: filters.type } } }),
  ...(filters.search && {
    follower: { username: { $containsi: filters.search } },
  }),
  ...getDateRange(filters.dateRange),
});
