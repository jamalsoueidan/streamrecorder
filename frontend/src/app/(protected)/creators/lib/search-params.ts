import { getDateRange } from "@/app/lib/get-date-range";
import { SortOptions } from "@/lib/types/filtering";
import { ScopeEnum } from "@/lib/types/strapi-autogenerated";
import {
  createSearchParamsCache,
  inferParserType,
  parseAsBoolean,
  parseAsString,
  parseAsStringEnum,
} from "nuqs/server";

export const exploreParsers = {
  sort: parseAsStringEnum<SortOptions>(Object.values(SortOptions)).withDefault(
    SortOptions.createdAtDesc
  ),
  hasRecordings: parseAsBoolean.withDefault(true),
  scope: parseAsStringEnum<ScopeEnum>(Object.values(ScopeEnum)).withDefault(
    ScopeEnum.Following
  ),
  gender: parseAsString,
  country: parseAsString,
  language: parseAsString,
  type: parseAsString,
  search: parseAsString,
  dateRange: parseAsString,
};

export const creatorsParamscache = createSearchParamsCache(exploreParsers);

export type ExploreFilters = inferParserType<typeof exploreParsers>;

export const buildCreatorsFilters = (filters: ExploreFilters) => ({
  ...(filters.gender && { gender: { $eq: filters.gender } }),
  ...(filters.country && { countryCode: { $eq: filters.country } }),
  ...(filters.language && { languageCode: { $eq: filters.language } }),
  ...(filters.type && { type: { $eq: filters.type } }),
  ...(filters.search && { username: { $containsi: filters.search } }),
  ...getDateRange(filters.dateRange),
});
