// mini-player.tsx
"use client";

import { combinePlaylistsFromSources } from "@/app/(protected)/[type]/[username]/live/[id]/_components/player-utils";
import { Source } from "@/lib/types/strapi-autogenerated";
import { useMounted } from "@mantine/hooks";
import { useEffect, useRef, useState } from "react";
import videojs from "video.js";
import Player from "video.js/dist/types/player";
import "video.js/dist/video-js.css";

interface Props {
  sources: Source[];
}

export function MiniPlayer({ sources }: Props) {
  const containerRef = useRef<HTMLDivElement>(null);
  const videoRef = useRef<HTMLVideoElement>(null);
  const playerRef = useRef<Player | null>(null);
  const playlistUrlRef = useRef<string | null>(null);
  const mounted = useMounted();
  const [progress, setProgress] = useState(0);
  const [loading, setLoading] = useState(true);
  const [seeking, setSeeking] = useState(false);
  const [dragging, setDragging] = useState(false);

  const totalDuration = sources.reduce((sum, s) => sum + (s.duration || 0), 0);

  useEffect(() => {
    if (!mounted || !sources || sources.length === 0) return;

    const smallMissing = sources.some((s) => !s.videoSmall);

    const combinedPlaylist = combinePlaylistsFromSources(
      sources,
      smallMissing ? "original" : "small"
    );

    if (!combinedPlaylist || combinedPlaylist.length < 50) return;

    const blob = new Blob([combinedPlaylist], {
      type: "application/vnd.apple.mpegurl",
    });
    const playlistUrl = URL.createObjectURL(blob);
    playlistUrlRef.current = playlistUrl;

    if (videoRef.current && !playerRef.current) {
      const player = videojs(videoRef.current, {
        autoplay: true,
        muted: true,
        controls: false,
        fluid: false, // Don't use fluid
        fill: true, // Fill the container
        responsive: false,
        loadingSpinner: false,
        html5: {
          vhs: {
            overrideNative: true,
          },
          nativeAudioTracks: false,
          nativeVideoTracks: false,
        },
      });

      player.src({
        src: playlistUrl,
        type: "application/x-mpegURL",
      });

      player.on("playing", () => {
        setLoading(false);
      });

      player.on("timeupdate", () => {
        if (!dragging) {
          const current = player.currentTime() || 0;
          const duration = player.duration() || totalDuration;
          setProgress((current / duration) * 100);
        }
      });

      player.on("seeking", () => setSeeking(true));
      player.on("seeked", () => setSeeking(false));

      playerRef.current = player;
    }

    return () => {
      if (playerRef.current) {
        playerRef.current.dispose();
        playerRef.current = null;
      }
      if (playlistUrlRef.current) {
        URL.revokeObjectURL(playlistUrlRef.current);
        playlistUrlRef.current = null;
      }
    };
  }, [mounted, sources, totalDuration, dragging]);

  const handleSeek = (clientX: number, rect: DOMRect) => {
    if (!playerRef.current) return;
    const percent = Math.max(
      0,
      Math.min(1, (clientX - rect.left) / rect.width)
    );
    setProgress(percent * 100);
    const duration = playerRef.current.duration() || totalDuration;
    playerRef.current.currentTime(percent * duration);
  };

  const handleProgressClick = (e: React.MouseEvent<HTMLDivElement>) => {
    e.preventDefault();
    e.stopPropagation();
    handleSeek(e.clientX, e.currentTarget.getBoundingClientRect());
  };

  const handleMouseDown = (e: React.MouseEvent<HTMLDivElement>) => {
    e.preventDefault();
    e.stopPropagation();
    setDragging(true);
    const progressBar = e.currentTarget.parentElement!.parentElement!;
    const rect = progressBar.getBoundingClientRect();

    const handleMouseMove = (e: MouseEvent) => {
      handleSeek(e.clientX, rect);
    };

    const handleMouseUp = () => {
      setDragging(false);
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
    };

    document.addEventListener("mousemove", handleMouseMove);
    document.addEventListener("mouseup", handleMouseUp);
  };

  if (!mounted) return null;

  const showSpinner = loading || seeking;

  return (
    <div
      ref={containerRef}
      className="mini-player-wrapper"
      style={{
        position: "absolute", // Fill parent
        inset: 0, // top/right/bottom/left = 0
        borderRadius: 8,
        overflow: "hidden",
      }}
    >
      <style jsx global>{`
        @keyframes mini-player-spin {
          to {
            transform: rotate(360deg);
          }
        }

        .mini-player-wrapper .video-js,
        .mini-player-wrapper .vjs-tech,
        .mini-player-wrapper [data-vjs-player] {
          position: absolute !important;
          inset: 0 !important;
          width: 100% !important;
          height: 100% !important;
          background: transparent !important;
          background-color: transparent !important;
        }

        .mini-player-wrapper .vjs-tech {
          background-color: #000 !important;
          border-radius: 10px !important;
          overflow: hidden !important;
          object-fit: contain;
        }

        .mini-player-wrapper .vjs-control-bar,
        .mini-player-wrapper .vjs-big-play-button,
        .mini-player-wrapper .vjs-loading-spinner,
        .mini-player-wrapper .vjs-poster,
        .mini-player-wrapper .vjs-modal-dialog,
        .vjs-loading-spinner {
          display: none !important;
          visibility: hidden !important;
          opacity: 0 !important;
        }
      `}</style>

      {/* Video container */}
      <div
        data-vjs-player
        style={{
          position: "absolute",
          inset: 0,
          opacity: loading ? 0 : 1,
          transition: "opacity 0.2s ease",
        }}
      >
        <video
          ref={videoRef}
          className="video-js vjs-default-skin vjs-fill"
          playsInline
          style={{
            position: "absolute",
            inset: 0,
            width: "100%",
            height: "100%",
          }}
        />
      </div>

      {/* Loading spinner */}
      {showSpinner && (
        <div
          style={{
            position: "absolute",
            top: "50%",
            left: "50%",
            transform: "translate(-50%, -50%)",
            background: "rgba(0,0,0,0.6)",
            borderRadius: "50%",
            width: 40,
            height: 40,
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            zIndex: 5,
          }}
        >
          <div
            style={{
              width: 20,
              height: 20,
              border: "2px solid #fff",
              borderTopColor: "transparent",
              borderRadius: "50%",
              animation: "mini-player-spin 0.8s linear infinite",
            }}
          />
        </div>
      )}

      {/* Progress bar */}
      {!loading && (
        <div
          onClick={handleProgressClick}
          style={{
            position: "absolute",
            bottom: 8,
            left: 8,
            right: 8,
            height: 24,
            paddingTop: 12,
            cursor: "pointer",
            zIndex: 10,
          }}
        >
          <div
            style={{
              height: 14,
              background: "rgba(255,255,255,0.3)",
              borderRadius: 12,
              position: "relative",
            }}
          >
            <div
              style={{
                height: "100%",
                width: `${progress}%`,
                background: "#fff",
                borderStartStartRadius: 12,
                borderEndStartRadius: 12,
                position: "relative",
              }}
            >
              <div
                onMouseDown={handleMouseDown}
                style={{
                  position: "absolute",
                  right: -12,
                  top: "50%",
                  transform: "translateY(-50%)",
                  width: 16,
                  height: 16,
                  background: "#fff",
                  borderRadius: "50%",
                  cursor: "grab",
                  boxShadow: "0 1px 4px rgba(0,0,0,0.4)",
                }}
              />
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
