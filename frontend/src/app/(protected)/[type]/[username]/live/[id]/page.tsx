"use client";

import { Box, Flex, Loader } from "@mantine/core";
import { useInfiniteQuery } from "@tanstack/react-query";
import { useParams, useRouter, useSearchParams } from "next/navigation";
import { useQueryStates } from "nuqs";
import { useCallback, useMemo } from "react";

import { VideoScrollPlayer } from "@/app/(protected)/components/video/video-scroll-player";
import { Recording } from "@/lib/types/strapi-autogenerated";
import { fetchProfileRecordings } from "../../actions/actions";
import { profileParsers } from "../../lib/search-params";

const SHELL_HEIGHT =
  "calc(100dvh - var(--app-shell-header-height, 0px) - var(--app-shell-footer-height, 0px) - var(--app-shell-padding) * 2)";

export default function VideoPage() {
  const router = useRouter();
  const params = useParams<{
    id: string;
    username: string;
    type: string;
  }>();
  const searchParams = useSearchParams();
  const [filters] = useQueryStates(profileParsers);

  const { data, fetchNextPage, hasNextPage, isFetchingNextPage, isLoading } =
    useInfiniteQuery({
      queryKey: ["profile-recordings", params.type, params.username, filters],
      queryFn: ({ pageParam }) =>
        fetchProfileRecordings(
          params.type,
          params.username,
          filters,
          pageParam
        ),
      initialPageParam: 1,
      getNextPageParam: (lastPage) => {
        const { page = 1, pageCount = 0 } = lastPage.meta?.pagination ?? {};
        return page < pageCount ? page + 1 : undefined;
      },
    });

  const recordings = useMemo(
    () => data?.pages.flatMap((p) => p.data) ?? [],
    [data]
  );

  const handleVisibleChange = useCallback(
    (recording: Recording) => {
      const basePath = `/${params.type}/${params.username}/live/${recording.documentId}`;
      const search = searchParams.toString();
      const url = search ? `${basePath}?${search}` : basePath;
      window.history.replaceState(null, "", url);
    },
    [params.type, params.username, searchParams]
  );

  const handleClose = () => {
    // Go back to profile page
    router.push(`/${params.type}/${params.username}`);
  };

  if (isLoading) {
    return (
      <Box h={SHELL_HEIGHT} pos="relative">
        <Flex h="100%" justify="center" align="center">
          <Loader size="lg" />
        </Flex>
      </Box>
    );
  }

  return (
    <Box
      h={SHELL_HEIGHT}
      pos="relative"
      style={{ borderRadius: "var(--mantine-radius-md)", overflow: "hidden" }}
    >
      <VideoScrollPlayer
        recordings={recordings}
        initialId={params.id}
        hasNextPage={hasNextPage}
        isFetchingNextPage={isFetchingNextPage}
        onFetchNextPage={fetchNextPage}
        onVisibleChange={handleVisibleChange}
        onClose={handleClose}
        showCloseButton={true}
        height="100%"
      />
    </Box>
  );
}
