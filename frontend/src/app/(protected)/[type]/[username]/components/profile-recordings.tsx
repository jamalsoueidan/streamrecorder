"use client";

import { ImageVideoPreview } from "@/app/(protected)/components/image-video-preview";
import dayjs from "@/app/lib/dayjs";
import {
  FollowerTypeEnum,
  SourceStateEnum,
} from "@/lib/types/strapi-autogenerated";
import {
  Group,
  Loader,
  SegmentedControl,
  SimpleGrid,
  Stack,
  Text,
} from "@mantine/core";
import { useIntersection } from "@mantine/hooks";
import { useInfiniteQuery } from "@tanstack/react-query";
import { useParams } from "next/navigation";
import { useQueryStates } from "nuqs";
import { useEffect, useRef } from "react";

import { fetchProfileRecordings } from "../actions/actions";
import { profileParsers, SortOptions } from "../lib/search-params";

export default function ProfileRecordings() {
  const params = useParams<{ type: FollowerTypeEnum; username: string }>();
  const isFetchingRef = useRef(false);
  const [filters, setFilters] = useQueryStates(profileParsers);

  const { data, fetchNextPage, hasNextPage, isFetchingNextPage, isLoading } =
    useInfiniteQuery({
      queryKey: ["profile-recordings", params.type, params.username, filters],
      queryFn: ({ pageParam }) =>
        fetchProfileRecordings(
          params.type,
          params.username,
          filters,
          pageParam
        ),
      initialPageParam: 1,
      getNextPageParam: (lastPage) => {
        const { page = 1, pageCount = 0 } = lastPage.meta?.pagination ?? {};
        return page < pageCount ? page + 1 : undefined;
      },
    });

  const { ref, entry } = useIntersection({ threshold: 0.5 });

  useEffect(() => {
    isFetchingRef.current = isFetchingNextPage;
  }, [isFetchingNextPage]);

  useEffect(() => {
    if (entry?.isIntersecting && hasNextPage && !isFetchingRef.current) {
      isFetchingRef.current = true;
      fetchNextPage();
    }
  }, [entry?.isIntersecting, hasNextPage, fetchNextPage]);

  const recordings = data?.pages.flatMap((p) => p.data) ?? [];

  if (isLoading) {
    return (
      <Stack align="center" py="xl">
        <Loader size="lg" />
      </Stack>
    );
  }

  return (
    <Stack gap="md">
      <Group justify="flex-end">
        <SegmentedControl
          value={filters.sort}
          onChange={(value) => setFilters({ sort: value as SortOptions })}
          data={[
            { label: "Newest", value: SortOptions.createdAtDesc },
            { label: "Oldest", value: SortOptions.createdAtAsc },
          ]}
        />
      </Group>

      <SimpleGrid cols={{ base: 1, sm: 2, md: 3, xl: 4 }} spacing="lg">
        {recordings.map((rec) => {
          const isRecording = rec.sources?.some(
            (s) => s.state === SourceStateEnum.Recording
          );

          return (
            <Stack key={rec.documentId} gap={4}>
              <ImageVideoPreview
                recording={rec}
                username={params.username}
                type={params.type}
              />
              <Text size="xs">
                {isRecording
                  ? `recording for ${dayjs(rec.createdAt).fromNow(true)}`
                  : `recorded ${dayjs(rec.createdAt).fromNow()}`}
              </Text>
            </Stack>
          );
        })}
      </SimpleGrid>

      {hasNextPage && !isFetchingNextPage && (
        <div ref={ref} style={{ height: 20 }} />
      )}
      {isFetchingNextPage && (
        <Loader size="sm" style={{ alignSelf: "center" }} />
      )}
      {!hasNextPage && recordings.length > 0 && (
        <Text ta="center" c="dimmed" size="sm">
          No more recordings
        </Text>
      )}
    </Stack>
  );
}
