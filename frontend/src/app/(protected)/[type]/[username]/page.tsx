import dayjs from "@/app/lib/dayjs";
import api from "@/lib/api";
import { SortOptions } from "@/lib/types/filtering";
import { Follower } from "@/lib/types/strapi-autogenerated";
import {
  ActionIcon,
  Anchor,
  Avatar,
  Box,
  Button,
  deepMerge,
  Group,
  Stack,
  Text,
  Title,
} from "@mantine/core";
import {
  IconClock,
  IconStar,
  IconVideo,
  IconWorldSearch,
} from "@tabler/icons-react";
import { CountryFlag } from "../../components/country-flag";
import FollowButton from "../../components/follow-button";
import { FollowerTypeIcon } from "../../components/follower-type";
import InfiniteRecordings from "../../components/infinity-recordings";
import OpenSocial from "../../components/open-social";
import UnfollowButton from "../../components/unfollow-button";
import { AdminMenu } from "./components/admin-menu";

const defaultOptions = {
  filters: {
    // give me all recordings that are done or recording
    sources: {
      state: {
        $in: ["done", "recording"],
      },
    },
  },
  populate: {
    sources: {
      fields: ["*"],
      filters: {
        // filter out from source
        state: {
          $ne: "failed",
        },
      },
      populate: ["videoSmall", "videoOriginal"], // we ask for original because sometime small is null while encoding for mini-player
    },
    follower: {
      fields: ["username", "type"],
      populate: {
        avatar: {
          fields: ["url"],
        },
      },
    },
  },
};

interface PageProps {
  params: Promise<{
    username: string;
    type: string;
  }>;
}

export default async function Page({ params }: PageProps) {
  const { type, username } = await params;

  const response = await api.follower.getFollowers({
    filters: {
      username,
      type,
    },
    populate: ["avatar"],
  });

  const follower = response.data.data?.at(0);

  if (!follower) {
    return <>Not found</>;
  }

  const user =
    await api.usersPermissionsUsersRoles.getUsersPermissionsUsersRoles({
      populate: {
        followers: {
          fields: ["id"],
          filters: {
            documentId: {
              $eq: follower?.documentId,
            },
          },
        },
      },
    });

  const followers: Follower[] = (user.data as any).followers;
  const isFollowing = followers.find((f) => f.id === follower.id);

  const fetchAction = async (
    options: Parameters<typeof api.recording.browseRecordings>[0]
  ) => {
    "use server";
    const response = await api.recording.browseRecordings(
      deepMerge(defaultOptions, {
        filters: {
          follower: {
            documentId: {
              $eq: follower?.documentId,
            },
          },
        },
        ...options,
        "pagination[pageSize]": 10,
      })
    );

    return response.data;
  };

  const { data, meta } = await fetchAction({
    "pagination[page]": 1,
    sort: SortOptions.createdAtDesc,
  });

  const isRecording = data?.some((r) =>
    r.sources?.some((s) => s.state === "recording")
  );

  return (
    <section>
      <Group mb="xl">
        <Box pos="relative">
          <Avatar
            size={150}
            src={follower.avatar?.url}
            style={{
              ...(isRecording
                ? {
                    border: "3px solid red",
                  }
                : {}),
            }}
            styles={{
              image: {
                transform: "scale(2)",
                objectFit: "cover",
              },
            }}
          >
            <IconStar size={1} />
          </Avatar>

          {follower.type ? (
            <>
              <FollowerTypeIcon
                pos="absolute"
                color="transparent"
                type={follower?.type}
                top="50%"
                left="50%"
                size={90}
                style={{ transform: "translate(-50%, -50%)" }}
              />
            </>
          ) : null}
        </Box>

        <Stack gap="xs">
          <Group>
            <Title order={2}>{follower.username}</Title>
            {follower.country ? (
              <CountryFlag
                country={follower.country}
                countryCode={follower?.countryCode}
                size={40}
              />
            ) : null}
          </Group>

          <Group gap="xs">
            <OpenSocial follower={follower} />
            {isFollowing ? (
              <>
                <UnfollowButton
                  username={follower.username!}
                  type={follower.type}
                />
              </>
            ) : (
              <FollowButton
                username={follower.username!}
                type={follower.type}
              />
            )}
            <AdminMenu follower={follower} />
          </Group>
          <div>
            <Text size="sm" c="dimmed">
              added {dayjs(follower.createdAt).fromNow()}
            </Text>
            <Text size="sm" c="dimmed">
              last checked {dayjs(follower.lastCheckedAt).fromNow()}
            </Text>
          </div>
        </Stack>
      </Group>

      {data?.length === 0 ? (
        (() => {
          const isNewlyAdded =
            dayjs().diff(dayjs(follower.createdAt), "minute") < 5;

          if (isNewlyAdded) {
            return (
              <Stack align="center" justify="center" py={80} gap="lg">
                <ActionIcon
                  variant="transparent"
                  size={120}
                  radius="xl"
                  color="blue"
                >
                  <IconClock size={90} stroke={2} />
                </ActionIcon>
                <Stack align="center" gap={12}>
                  <Title order={2} fw={600}>
                    You&apos;re now following {follower.username}!
                  </Title>
                  <Text size="xl" c="dimmed" maw={450} ta="center">
                    We&apos;ll start monitoring their streams and save
                    recordings for you automatically.
                  </Text>
                </Stack>
              </Stack>
            );
          }

          return (
            <Stack align="center" justify="center" py={80} gap="lg">
              <ActionIcon
                variant="transparent"
                size={120}
                radius="xl"
                color="white"
              >
                <IconVideo size={90} stroke={2} />
              </ActionIcon>
              <Stack align="center" gap={12}>
                <Title order={2} fw={600}>
                  No recordings yet
                </Title>
                <Text size="xl" c="dimmed" maw={450} ta="center">
                  We haven&apos;t captured any streams from {follower.username}{" "}
                  yet. Check back later!
                </Text>
              </Stack>
              <Anchor href="/discover" underline="never">
                <Button
                  size="lg"
                  radius="md"
                  leftSection={<IconWorldSearch size={20} />}
                >
                  Discover Streamers
                </Button>
              </Anchor>
            </Stack>
          );
        })()
      ) : (
        <InfiniteRecordings
          initialData={data}
          initialPagination={meta}
          initialSort={SortOptions.createdAtDesc}
          fetchAction={fetchAction}
        />
      )}
    </section>
  );
}
