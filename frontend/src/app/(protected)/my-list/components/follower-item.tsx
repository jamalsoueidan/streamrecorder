// components/infinite-followers.tsx
"use client";

import dayjs from "@/app/lib/dayjs";
import {
  FollowerWithMeta,
  SourceStateEnum,
} from "@/lib/types/strapi-autogenerated";
import {
  Accordion,
  AccordionControlProps,
  Anchor,
  Avatar,
  Box,
  Center,
  Flex,
  Group,
  Image,
  Loader,
  Pagination,
  SimpleGrid,
  Stack,
  Text,
  useMatches,
} from "@mantine/core";
import Link from "next/link";

import { ImageVideoPreview } from "@/app/(protected)/components/image-video-preview";
import { IconCalendarPlus, IconVideo } from "@tabler/icons-react";
import { useQuery } from "@tanstack/react-query";
import { useState } from "react";
import { CountryFlag } from "../../components/country-flag";
import FollowButton from "../../components/follow-button";
import OpenSocial from "../../components/open-social";
import UnfollowButton from "../../components/unfollow-button";
import { getRecordings } from "../actions/fetch-followers";

function AccordionControl({
  follower,
  ...props
}: AccordionControlProps & { follower: FollowerWithMeta }) {
  return (
    <Center>
      <Accordion.Control {...props} />
      <Flex gap="xs" align="center" mr="md">
        <OpenSocial follower={follower} />

        {follower.isFollowing ? (
          <>
            <UnfollowButton username={follower.username} type={follower.type} />
          </>
        ) : (
          <FollowButton username={follower.username} type={follower.type} />
        )}
      </Flex>
    </Center>
  );
}

interface Props {
  follower: FollowerWithMeta;
  isOpen: boolean;
}

export default function FollowerItem({ follower, isOpen }: Props) {
  const [page, setPage] = useState(1);
  const mawTruncate = useMatches({
    base: 200,
    md: 120,
  });

  const { data, isLoading } = useQuery({
    queryKey: ["recordings", follower.username, follower.type, page],
    queryFn: () => getRecordings(follower.username, follower.type, page),
    enabled: isOpen,
    staleTime: 1000 * 60 * 5,
  });

  const recordings = data?.data ?? [];
  const totalPages = data?.meta?.pagination?.pageCount ?? 1;

  return (
    <Accordion.Item key={follower.documentId} value={follower.username}>
      <AccordionControl follower={follower}>
        <Flex justify="space-between">
          <Group>
            <Anchor
              component={Link}
              href={`/${follower?.type}/${follower?.username}`}
            >
              <Avatar
                size="lg"
                src={follower.avatar?.url}
                styles={{
                  image: {
                    transform: "scale(2)",
                    objectFit: "cover",
                  },
                }}
              />
            </Anchor>

            <Stack gap={2}>
              <Group gap="xs">
                <Anchor
                  component={Link}
                  href={`/${follower?.type}/${follower?.username}`}
                  size="md"
                >
                  <Text size="lg" truncate maw={mawTruncate} fw="bold">
                    {follower.username}
                  </Text>
                </Anchor>
                {follower.country ? (
                  <CountryFlag
                    country={follower.country}
                    countryCode={follower?.countryCode}
                  />
                ) : null}
              </Group>

              <Group gap="xs">
                <Group gap={4}>
                  <IconCalendarPlus size={14} />
                  <Text size="sm" c="dimmed">
                    Added {dayjs(follower.createdAt).fromNow()}
                  </Text>
                </Group>
                <Group gap={4}>
                  <IconVideo size={14} />
                  <Text size="sm" c="dimmed">
                    {follower.totalRecordings}{" "}
                    {follower.totalRecordings === 1 ? "video" : "videos"}
                  </Text>
                </Group>
              </Group>
            </Stack>
          </Group>
        </Flex>
      </AccordionControl>
      <Accordion.Panel>
        {isLoading ? (
          <Stack align="center" py="xl">
            <Loader size="sm" />
          </Stack>
        ) : recordings.length > 0 ? (
          <Stack mt="lg" gap="lg">
            <SimpleGrid cols={{ sm: 2, md: 3, xl: 4 }} spacing="lg">
              {recordings.map((rec) => {
                const isRecording = rec.sources?.some(
                  (s) => s.state === SourceStateEnum.Recording
                );

                return (
                  <Stack key={rec.documentId} gap="4">
                    <ImageVideoPreview
                      recording={rec}
                      username={follower.username}
                      type={follower.type}
                    />

                    <div>
                      <Text size="xs">
                        {isRecording
                          ? `recording for ${dayjs(rec.createdAt).fromNow(
                              true
                            )}`
                          : `recorded ${dayjs(rec.createdAt).fromNow()}`}
                      </Text>
                    </div>
                  </Stack>
                );
              })}
            </SimpleGrid>

            {totalPages > 1 && (
              <Pagination
                value={page}
                onChange={setPage}
                total={totalPages}
                siblings={1}
                style={{ alignSelf: "center" }}
              />
            )}
          </Stack>
        ) : (
          <Box
            mt="lg"
            pos="relative"
            w={160}
            h={284}
            style={{
              overflow: "hidden",
              borderRadius: "var(--mantine-radius-md)",
            }}
          >
            <Image
              alt="no videos"
              radius="md"
              src="https://placehold.co/180x280/1a1b1e/909296?text=No videos yet"
              w={160}
              h={284}
              loading="lazy"
              style={{ objectFit: "cover", opacity: 0.8 }}
            />
          </Box>
        )}
      </Accordion.Panel>
    </Accordion.Item>
  );
}
