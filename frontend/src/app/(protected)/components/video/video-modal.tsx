// components/video-modal-content.tsx
"use client";

import { Recording } from "@/lib/types/strapi-autogenerated";
import { ActionIcon, Flex, Modal } from "@mantine/core";
import { IconX } from "@tabler/icons-react";
import { useRouter, useSearchParams } from "next/navigation";
import { useCallback, useEffect, useState } from "react";
import { PlayBack } from "./playback";
import { VideoPlayer } from "./video-player";

interface Props {
  initialId: string;
  username: string;
  type: string;
  initialRecording: Recording;
  initialPrevId: string | null;
  initialNextId: string | null;
  fetchAction: (id: string) => Promise<{
    recording: Recording;
    prevId: string | null;
    nextId: string | null;
  }>;
}

export function VideoModal({
  initialId,
  username,
  type,
  initialRecording,
  initialPrevId,
  initialNextId,
  fetchAction,
}: Props) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [currentId, setCurrentId] = useState(initialId);
  const [recording, setRecording] = useState(initialRecording);
  const [prevId, setPrevId] = useState(initialPrevId);
  const [nextId, setNextId] = useState(initialNextId);
  const [loading, setLoading] = useState(false);

  const basePath = `/${type}/${username}/live`;
  const queryString = searchParams.toString();

  useEffect(() => {
    const url = `${basePath}/${currentId}${
      queryString ? `?${queryString}` : ""
    }`;
    window.history.replaceState({}, "", url);
  }, [currentId, basePath, queryString]);

  const loadVideo = useCallback(
    async (id: string) => {
      setLoading(true);
      try {
        const data = await fetchAction(id);

        setRecording(data.recording);
        setPrevId(data.prevId);
        setNextId(data.nextId);
        setCurrentId(id);
      } catch (err) {
        console.error("Failed to load video", err);
      }
      setLoading(false);
    },
    [fetchAction]
  );

  return (
    <Modal
      opened={true}
      onClose={() => router.back()}
      fullScreen
      withCloseButton={false}
      transitionProps={{ duration: 0 }}
      styles={{
        body: { height: "100%", padding: 0, overflow: "hidden" },
      }}
    >
      <Flex h="100%" justify="center" align="center" pos="relative">
        <ActionIcon
          variant="subtle"
          color="white"
          size={60}
          radius="xl"
          onClick={() => router.back()}
          pos="absolute"
          top={20}
          right={20}
          style={{ zIndex: 10 }}
        >
          <IconX size={32} />
        </ActionIcon>

        <PlayBack
          prevId={prevId}
          nextId={nextId}
          basePath={`/${type}/${username}/live`}
          onPrev={() => loadVideo(prevId!)}
          onNext={() => loadVideo(nextId!)}
          loading={loading}
        />

        <VideoPlayer recording={recording} key={currentId} />
      </Flex>
    </Modal>
  );
}
