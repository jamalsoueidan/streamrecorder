import { Source } from "@/lib/types/strapi-autogenerated";

export function formatDuration(totalSeconds: number): string {
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = Math.floor(totalSeconds % 60);

  if (hours > 0) {
    return `${hours}:${minutes.toString().padStart(2, "0")}:${seconds
      .toString()
      .padStart(2, "0")}`;
  }
  return `${minutes}:${seconds.toString().padStart(2, "0")}`;
}

export function combinePlaylistsFromSources(
  sources: Source[],
  quality: "original" | "small"
): string {
  if (!sources || sources.length === 0) return "";

  let combined = "#EXTM3U\n#EXT-X-VERSION:7\n";
  let maxDuration = 0;
  let isFirst = true;

  // Reverse to go from oldest to newest
  for (const source of [...sources].reverse()) {
    const playlist =
      quality === "original"
        ? source.videoOriginal?.playlist
        : source.videoSmall?.playlist;

    if (!playlist) continue;

    const lines = playlist.split("\n");

    for (const line of lines) {
      if (line.startsWith("#EXTM3U")) continue;
      if (line.startsWith("#EXT-X-VERSION")) continue;
      if (line.startsWith("#EXT-X-MEDIA-SEQUENCE")) continue;
      if (line.startsWith("#EXT-X-ENDLIST")) continue;

      if (line.startsWith("#EXT-X-TARGETDURATION")) {
        const dur = parseInt(line.split(":")[1]);
        if (dur > maxDuration) maxDuration = dur;
        continue;
      }

      const baseUrl =
        typeof window !== "undefined" ? window.location.origin : "";

      if (line.startsWith("#EXT-X-MAP")) {
        if (!isFirst) {
          combined += "#EXT-X-DISCONTINUITY\n";
        }
        isFirst = false;
        combined +=
          line.replace(
            /URI="([^"]+)"/,
            `URI="${baseUrl}/media${source.path}$1"`
          ) + "\n";
        continue;
      }

      if (line.includes(".mp4")) {
        combined +=
          line.replace(/(\S+\.mp4)/g, `${baseUrl}/media${source.path}$1`) +
          "\n";
      } else if (line.trim()) {
        combined += line + "\n";
      }
    }
  }

  combined = combined.replace(
    "#EXT-X-VERSION:7\n",
    `#EXT-X-VERSION:7\n#EXT-X-TARGETDURATION:${maxDuration || 12}\n`
  );

  combined += "#EXT-X-ENDLIST\n";
  return combined;
}

export function buildVideoRanges(sources: Source[]) {
  const ranges: {
    start: number;
    end: number;
    path: string;
    interval: number;
    cols: number;
  }[] = [];

  const baseUrl = typeof window !== "undefined" ? window.location.origin : "";

  let cumTime = 0;
  for (const source of [...sources].reverse()) {
    const dur = source.duration || 0;
    ranges.push({
      start: cumTime,
      end: cumTime + dur,
      path: baseUrl + "/media" + source.path || "",
      interval: source.thumbnailInterval || 10,
      cols: source.thumbnailCols || 10,
    });
    cumTime += dur;
  }

  return ranges;
}
